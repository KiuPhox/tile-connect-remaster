var rr=Object.defineProperty;var ed=(nt,N,p)=>N in nt?rr(nt,N,{enumerable:!0,configurable:!0,writable:!0,value:p}):nt[N]=p;var l=(nt,N)=>rr(nt,"name",{value:N,configurable:!0});var u=(nt,N,p)=>ed(nt,typeof N!="symbol"?N+"":N,p);System.register(["./bundle/core.js","./bundle/__commonjsHelpers__.js"],function(nt,N){"use strict";var p,T,fo,it,$,ot,go;return{setters:[O=>{p=O.G,T=O.P,fo=O.M,it=O._,$=O.a,ot=O.C},O=>{go=O.g}],execute:l(function(){var Tt,Ot,Rt;const{Valid:O,Object:dt,String:Re,Json:wo}=p.Utils,Mt="is invalid",Q=class Q{static addDefaultData(e){O.isObject(e)||this.prototype.exception("default data",Mt),e=wo.clone(e);const{name:t}=this;O.isObject(Q.data[t])||(Q.data[t]={}),Q.data[t]=dt.merge(Q.data[t],e),console.info(`${t} default data:`,Q.data[t])}static getDefaultData(){const{name:e}=this;return wo.clone(Q.data[e])}static addValidateFunction(e,t){O.isString(e)||this.prototype.exception("validate key",Mt),typeof t!="function"&&this.prototype.exception("validate function",Mt);const s=`validate${Re.capitalize(e)}`;dt.assign(this.prototype,{[s]:t})}constructor(e){this.defaultData(),this.processData(e)}processData(e){this.validateStructure(e),this.validateData(e),this.setupData(e)}defaultData(){const{name:e}=this.constructor;this.lazyDefaultData(Q.data[e])}lazyDefaultData(e){O.isObject(e)||this.exception("data",Mt);for(const t in e)if(dt.hasOwn(e,t)){const s=e[t];dt.assign(this,{[t]:s})}}lazyValidateStructure(e){O.isObject(e)||this.exception("structure","is not object");const t=this.getKeys();for(const s of t){const a=this[s];a===void 0&&this.exception("structure",`has no key ${s}`),!dt.hasOwn(e,s)&&a!==void 0&&this.setDefaultData(s,e)}}setDefaultData(e,t){O.isObject(t)||this.exception("data",Mt);const s=this[e];s===void 0&&this.exception("default",`has no key ${e}`),dt.assign(t,{[e]:s})}lazyValidateData(e){const t=this.getKeys();for(const s of t){const a=e[s],n=Re.removeDiacritics(s).replace(/[^a-zA-Z0-9]/g,""),i=`validate${Re.capitalize(n)}`,o=this[i];if(typeof o=="function")try{o.call(this,a)}catch(r){console.warn(r),this.setDefaultData(s,e)}else this.exception("validate",`has no function ${i}`)}}lazySetupData(e){const t=this.getKeys();for(const s of t){const a=e[s];dt.assign(this,{[s]:a})}}validate(){this.validateData(this.toObject())}exception(e,t){throw new Error(`${this.constructor.name}: ${e} ${t}`)}toObject(){return Object.fromEntries(Object.entries(this).filter(([e])=>e!=="toObject"))}getKeys(){return Object.keys(this).filter(e=>e!=="toObject")}};l(Q,"BaseDtos"),u(Q,"data",{});let G=Q;p.Dtos={Base:G};const cr={score:"score",endlessScore:"endlessScore",settings:"settings",gameData:"gameData",remoteConfig:"remoteConfig",isFirstLogin:"isFirstLogin",dailyRewarded:"dailyRewarded",notificationData:"notificationData"},ht={ASID:null,playerId:"0000",name:"Guest",photo:"",locale:"en_US",connectedPlayers:{},data:{dailyRewarded:{logDays:[],lastRewarded:0},score:0,endlessScore:0,settings:{sound:!0,music:!0,vibrate:!0,language:"en"},gameData:{coins:0,level:1},isFirstLogin:!0,notificationData:{currentId:0,lastSent:0}}},{Valid:_t}=p.Utils,{playerId:lr,name:dr,photo:hr,locale:ur}=ht,$t="is invalid",Ra=class Ra extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateId(e){(!_t.isString(e)||!e)&&this.exception("_id",$t)}validatePlayerId(e){(!_t.isString(e)||!e)&&this.exception("playerId",$t)}validateName(e){(!_t.isString(e)||!e)&&this.exception("name",$t)}validatePhoto(e){_t.isString(e)||this.exception("photo",$t)}validateLocale(e){(!_t.isString(e)||!e)&&this.exception("locale",$t)}toObject(){return super.toObject()}};l(Ra,"PlayerInfoDtos");let Et=Ra;Et.addDefaultData({playerId:lr,name:dr,photo:hr,locale:ur});const Z=new Et({playerId:"10",name:"Your Friend"}).toObject(),Ma=class Ma extends Error{constructor(t){super(t);u(this,"code");this.code="CREATE_MATCH_FAILED"}};l(Ma,"ACreateMatchFailed");let H=Ma;const _a=class _a extends H{constructor(e){super(e),this.name="PlayerIdNotValid",this.message=e??"Player id is not valid"}};l(_a,"PlayerIdNotValid");let D=_a;const{Dtos:Me,Utils:yr,Events:pr}=p,{Array:fr,Object:gr,Json:_e,Valid:mo}=yr,$a=class $a{constructor(e){u(this,"game");u(this,"initContext",l(()=>{const e={contextId:GameSDK.context.getID(),contextType:GameSDK.context.getType(),entryPointData:GameSDK.getEntryPointData()},t=new Me.Context.Info(e),{contextId:s,contextType:a,entryPointData:n}=t.toObject();this.game.context.receiveContext(s,a,n)},"initContext"));u(this,"initPlayer",l(async()=>{const{player:e}=this.game,t=this.getPlayerInfo();console.info("playerInfo",_e.clone(t));const s=fr.unique(gr.vals(cr));console.info("dataKeys",s);const a=await GameSDK.player.getDataAsync(s);console.info("rawData",_e.clone(a));const n=new Me.Player.Data(a).toObject();console.info("playerData",_e.clone(n)),e.receiveData(t,n),this.game.event.emit(pr.PLAYER_INFO_LOADED)},"initPlayer"));u(this,"getPlayerInfo",l(()=>{try{const e=GameSDK.player.getID();let t=GameSDK.player.getName();const s=GameSDK.player.getPhoto(),a=GameSDK.getLocale();if(!mo.isString(e))throw new D;return mo.isString(t)||(t="You"),new Me.Player.Info({playerId:e,name:t,photo:s,locale:a}).toObject()}catch{return Z}},"getPlayerInfo"));this.game=e}};l($a,"StateInitiator");let $e=$a;const Ga=class Ga extends Error{constructor(t,s){super(t);u(this,"payload");this.name="BadRequest",this.message=t??"This request is bad",this.payload=s}};l(Ga,"BadRequest");let Gt=Ga;const ka=class ka extends Error{constructor(t,s){super(t);u(this,"payload");this.name="RequestTimeout",this.message=t??"This request is timeout",this.payload=s}};l(ka,"RequestTimeout");let kt=ka;const{Utils:wr,Configs:mr}=p,{AppId:Ao,Network:Ge}=mr,Ar=l(f=>{if(!f.ok)throw new Gt(void 0,{response:f})},"validateResponse"),Io=l(()=>{const f=window.game.auth.getToken();return{token:f,timeout:Ge.Timeout,headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"}}},"defaultConfig"),Do=l((f,e,t,s)=>async()=>{try{if(!Ao)throw new Gt("AppId is not defined");const a=`${f}/apps/${Ao}/${e}`,n=new AbortController;t.signal=n.signal;const i=setTimeout(()=>{n.abort()},t.timeout);p.Utils.Valid.isObject(s)&&(t.body=JSON.stringify(s));const o=await fetch(a,t);return clearTimeout(i),Ar(o),await o.json()||{}}catch(a){if(a instanceof Gt)return null;throw a instanceof Object&&"name"in a&&a.name==="AbortError"?new kt:a}},"requester"),ke=l(async(f,e)=>{try{return f()}catch(t){if(t instanceof kt&&e>0)try{return await wr.Time.sleepAsync(600),await ke(f,e-1)}catch{return{}}return t instanceof kt?{}:(console.warn("Request error",t),{})}},"handleRequest"),ut=l(async(f,e,t,s=Ge.Retries)=>{try{const a={...Io(),...e,method:"GET"},n=Do(t,f,a);return await ke(n,s)}catch(a){return console.warn("Get error",a),{}}},"get"),k=l(async(f,e,t,s,a=Ge.Retries)=>{try{const n={...Io(),...t,method:"POST"},i=Do(s,f,n,e);return await ke(i,a)}catch(n){return console.warn("Post error",n),{}}},"post"),{Configs:{Notification:{ApiUrl:Ir}},Utils:{Object:Dr}}=p,Pr=l(async f=>{if(!Dr.hasOwn(f,"playerId"))throw new Error("Missing playerId");const{playerId:e}=f;await k(`players/${e}`,f,{},Ir,10)},"updatePlayerProfileNotificationAsync");var Po=(f=>(f.IDLE="idle",f.LOADING="loading",f.FILLED="filled",f.SHOWING="showing",f))(Po||{});const Eo=Po;var xo=(f=>(f.BANNER="banner",f.INTERSTITIAL="interstitial",f.REWARDED_VIDEO="rewarded_video",f.REWARDED_INTERSTITIAL="rewarded_interstitial",f))(xo||{});const q=xo;let ie=(Tt=class extends Error{constructor(t,s){super(s);u(this,"code");this.code=t,this.message=s}},l(Tt,"AdError"),Tt);const Va=class Va{constructor(e,t){u(this,"type");u(this,"placementId");u(this,"_status");this.type=e,this._status=Eo.IDLE,this.placementId=t}setStatus(e){this._status!==e&&(this._status=e)}get status(){return this._status}exception(e){throw new ie("AD_INSTANCE_ERROR",e)}};l(Va,"BaseInstance");let Ve=Va,vo=(Ot=class extends Ve{loadAsync(){this.exception("This method is not implemented")}showAsync(){this.exception("This method is not implemented")}hideAsync(){this.exception("Unsupported method")}},l(Ot,"AdInstance"),Ot);p.Plugins.Ads={Types:q,Status:Eo,AdError:ie,AdInstance:vo};const{Array:Fe,Object:Er}=p.Utils,Fa=class Fa extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"enabled");u(this,"config");u(this,"lastCallAdShownTime");u(this,"isAdFullSizeShowed");u(this,"ads",{});u(this,"safeAreaBottom")}init(){this.lastCallAdShownTime={[q.BANNER]:0,[q.INTERSTITIAL]:0,[q.REWARDED_VIDEO]:0,[q.REWARDED_INTERSTITIAL]:0},this.isAdFullSizeShowed=!1,this.calculateSafeAreaBottom()}calculateSafeAreaBottom(){try{const t=getComputedStyle(document.documentElement).getPropertyValue("--sab");this.safeAreaBottom=Number.parseInt(t,10),Number.isNaN(this.safeAreaBottom)&&(this.safeAreaBottom=0)}catch{this.safeAreaBottom=0}}configure(t){this.config=t,this.enabled=this.config.Enabled}checkEnabled(){if(!this.enabled)throw new ie("ADS_NOT_ENABLED","Ads is't enabled")}isAdFullSizeShowing(){return this.isAdFullSizeShowed}setAdInstance(t,s,a){if(this.ads[s]){console.warn(`AdsPlugin: Ad instance with placementId ${s} already exists`);return}this.ads[s]={type:t,placementId:s,interval:null,instance:new a(t,s)}}async loadAdAsync(t,s){this.checkEnabled(),await this.getAd(t,s).instance.loadAsync()}async showAdAsync(t,s){this.checkEnabled();const{event:a}=this.game,n=this.getAd(t,s);this.lastCallAdShownTime[t]=window.performance.now()/1e3;try{a.emit(p.Events.AD_SHOWING,{placementId:s}),this.isAdFullSizeShowed=!0,await n.instance.showAsync()}finally{a.emit(p.Events.AD_CLOSED,{placementId:s}),this.isAdFullSizeShowed=!1}}getAdStatus(t,s){return this.checkEnabled(),this.getAd(t,s).instance.status}getAd(t,s){let a=null;if(s?a=this.getAdByPlacementId(s):a=this.getPriorityAdByType(t),!a)throw new ie("AD_INSTANCE_NOT_INITIATED","The instance ads not yet initiated");return a}getAdsByType(t){return Er.vals(this.ads).filter(s=>s.type===t)}getAdByPlacementId(t){const s=this.ads[t];return s||null}getPriorityAdByType(t){const s=this.getAdsByType(t);if(!s.length)return null;const a=Fe.search(s,n=>n.type===t);return a||null}canbeShowInterstitialAd(t){return this.canbeShowInterstitialAdByTime(t)}canbeShowInterstitialAdByTime(t){try{const s=window.performance.now()/1e3;let a;if(t)a=this.getCommonAdConfig(t);else{const d=this.getPriorityAdByType(q.INTERSTITIAL);if(!d)return!1;a=this.getCommonAdConfig(d.placementId)}const{SecondsBetweenAds:n,SecondsFirstTime:i}=a,o=s-this.lastCallAdShownTime[q.INTERSTITIAL],r=o>n,c=o>i;return this.lastCallAdShownTime[q.INTERSTITIAL]>0?r:c}catch(s){return console.warn("Error while checking canbeShowInterstitialAdByTime",s),!1}}canbeShowBannerAd(t){try{const s=this.getBannerConfig(t),{Platform:a}=s;if(a==="ALL")return!0;const n=GameSDK.getPlatform();return n?n===a:!1}catch(s){return console.warn("Error while checking canbeShowBannerAd",s),!1}}async showBannerAdAsync(t){this.checkEnabled();const s=this.getAd(q.BANNER,t);if(!this.canbeShowBannerAd(s.placementId))throw new Error("Banner ad can not be shown");this.cleanBannerReloadTimer(s.placementId),await s.instance.showAsync();const{event:a}=this.game;if(a.emit(p.Events.AD_SHOWING,{placementId:t}),GameSDK.getSDKName()==="MsGames")return;const n=this.getBannerConfig(s.placementId),{SecondsReload:i}=n;i<=0||(s.interval=setTimeout(()=>{this.showBannerAdAsync(s.placementId)},i*1e3))}async hideBannerAdAsync(t){this.checkEnabled();const s=this.getAd(q.BANNER,t);this.cleanBannerReloadTimer(s.placementId),await s.instance.hideAsync();const{event:a}=this.game;a.emit(p.Events.AD_CLOSED,{placementId:t})}cleanBannerReloadTimer(t){try{const s=this.getAd(q.BANNER,t),{interval:a}=s;if(!a)return;clearInterval(a)}catch(s){console.warn("Error while cleaning banner reload timer",s)}}getCommonAdConfig(t){const s=[...this.config.InterstitialAdOptions,...this.config.RewardedVideoAdOptions],a=Fe.search(s,n=>n.PlacementId===t);if(!a)throw new Error(`Ad config with placementId ${t} not found`);return a}getBannerConfig(t){const s=Fe.search(this.config.BannerDisplayAdOptions,a=>a.PlacementId===t);if(!s)throw new Error(`Banner config with placementId ${t} not found`);return s}getBannerHeight(t,s,a=!0){this.checkEnabled();const n=this.getBannerConfig(t),i=GameSDK.getBannerHeight(n);return a?(this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),(i+this.safeAreaBottom)*s):i*s}getSafeAreaBottom(t){return this.safeAreaBottom<=0&&this.calculateSafeAreaBottom(),this.safeAreaBottom*t}};l(Fa,"AdsPlugin");let Ue=Fa;const V={ENGINE_READY:"engine_ready",LOAD_START:"load_start",LOAD_COMPLETE:"load_complete",APP_READY:"app_ready",PAGE_VIEW:"page_view",SCREEN_OPEN:"screen_open",BUTTON_CLICK:"button_click",TUTORIAL_BEGIN:"tutorial_begin",TUTORIAL_STEP:"tutorial_step",TUTORIAL_COMPLETE:"tutorial_complete",MATCH_START:"match_start",MATCH_RESCUE:"match_rescue",MATCH_END:"match_end",LEVEL_START:"level_start",LEVEL_RESCUE:"level_rescue",LEVEL_END:"level_end",SHARE:"share",MESSAGE:"message",INVITE:"invite",SHORTCUT_CREATE:"shortcut_create",SHORTCUT_CREATE_POPUP:"shortcut_create_popup",BOT_SUBSCRIBE:"bot_subscribe",BOT_SUBSCRIBE_POPUP:"bot_subscribe_popup",AD_LOAD:"ad_load",AD_LOAD_FAILED:"ad_load_failed",AD_SHOW:"ad_show",AD_SHOW_FAILED:"ad_show_failed",AD_SHOWING:"ad_showing",AD_REWARD:"ad_reward",NEW_USER:"new_user",RETURNING_USER:"returning_user",JOIN_GROUP:"join_group",TOURNAMENT_START:"tournament_start",TOURNAMENT_SHARE:"tournament_share",TOURNAMENT_CREATE:"tournament_create",TOURNAMENT_POST_SCORE:"tournament_post_score",GET_FREE_ITEM:"get_free_item",USE_ITEM:"use_item",EARN_ITEM:"earn_item"},{String:yt,Valid:xr}=p.Utils;let vr=(Rt=class{constructor(e,t,s){u(this,"game");u(this,"name");u(this,"color");u(this,"options");u(this,"selfLog");u(this,"currentPath");this.game=e,this.name=t,this.options=s,this.color=s.color||"#FFF",this.selfLog=s.log,this.currentPath="/",console.info(`%c${this.name}: init`,`color: ${this.color}`,this.options)}event(e,t){this.logInfo("event",{name:e,payload:t});const s=this.formatEventName(e);this.processEvent(s,t)}logInfo(e,t){this.selfLog&&console.info(`%c${this.name}: ${e}`,`color: ${this.color}`,t)}pageview(e){let t=this.getPageTitle(e);t=this.addGameModeToPageTitle(t),console.info("AnalyticsService: Page view",t),document.title=t,this.event(V.PAGE_VIEW,{path_path:e,page_title:t})}levelStart(e,t,s){this.event(V.LEVEL_START,{level:e,score:t,level_name:this.getLevelName(e),game_mode:s?yt.toUpperCamelCase(s):void 0})}levelFail(e,t,s){this.event(V.LEVEL_END,{level:e,score:t,success:!1,level_name:this.getLevelName(e),game_mode:s?yt.toUpperCamelCase(s):void 0})}levelRescue(e,t,s){this.event(V.LEVEL_RESCUE,{level:e,score:t,level_name:this.getLevelName(e),game_mode:s?yt.toUpperCamelCase(s):void 0})}levelComplete(e,t,s){this.event(V.LEVEL_END,{level:e,score:t,success:!0,level_name:this.getLevelName(e),game_mode:s?yt.toUpperCamelCase(s):void 0})}loadAdEvent(e,t){this.event(V.AD_LOAD,{ad_type:e,screen_name:t})}showAdEvent(e,t){this.event(V.AD_SHOW,{ad_type:e,screen_name:t})}loadInterstitialAd(e){this.loadAdEvent("interstitial",e)}showInterstitialAd(e){this.showAdEvent("interstitial",e)}loadRewardedVideoAd(e){this.loadAdEvent("rewarded_video",e)}showRewardedVideoAd(e){this.showAdEvent("rewarded_video",e)}receiveVideoReward(e){this.event(V.AD_REWARD,{screen_name:e})}loadRewardedInterstitialAd(e){this.loadAdEvent("rewarded_interstitial",e)}showRewardedInterstitialAd(e){this.showAdEvent("rewarded_interstitial",e)}receiveInterstitialReward(e){this.event(V.AD_REWARD,{screen_name:e})}loadAdFail(e,t){this.event(V.AD_LOAD_FAILED,{ad_type:e,screen_name:t})}showAdFail(e,t){this.event(V.AD_SHOW_FAILED,{ad_type:e,screen_name:t})}showingAd(e,t){this.event(V.AD_SHOWING,{ad_type:e,screen_name:t})}formatEventName(e){return e.toLowerCase().replace(/:/g,"_")}getLevelName(e){return`Level ${yt.padStart(e.toString(),5,"0")}`}getPageTitle(e){const t=e.split("/").pop();if(!xr.isString(t))return e;const s=t.replace(/([-_\s.])/g," $1");return yt.toUpperCamelCase(s)}addGameModeToPageTitle(e){const{match:t}=this.game,s=t.getMatchState();let{mode:a}=s;return a||(a="Normal"),`${yt.toUpperCamelCase(a)}::${e}`}},l(Rt,"BaseAnalytics"),Rt);p.Plugins.Analytics={Events:V,BaseAnalytics:vr};const Ua=class Ua extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"analytics",[]);u(this,"placement","unknown");u(this,"pageview",l(t=>{if(!this.isActive())return;this.placement=t;const s=this.getPageByKey(t);for(const a of this.analytics)a.pageview(s)},"pageview"))}add(t){this.analytics.some(a=>a.name===t.name)||this.analytics.push(t)}isActive(){return this.analytics.length>=1}event(t,s){if(this.isActive())for(const a of this.analytics)a.event(t,s)}levelStart(t,s,a){if(this.isActive())for(const n of this.analytics)n.levelStart(t,s,a)}levelRescue(t,s,a){if(this.isActive())for(const n of this.analytics)n.levelRescue(t,s,a)}levelFail(t,s,a){if(this.isActive())for(const n of this.analytics)n.levelFail(t,s,a)}levelComplete(t,s,a){if(this.isActive())for(const n of this.analytics)n.levelComplete(t,s,a)}loadInterstitialAd(){if(this.isActive())for(const t of this.analytics)t.loadInterstitialAd(this.placement)}showInterstitialAd(){if(this.isActive())for(const t of this.analytics)t.showInterstitialAd(this.placement)}loadRewardedVideoAd(){if(this.isActive())for(const t of this.analytics)t.loadRewardedVideoAd(this.placement)}showRewardedVideoAd(){if(this.isActive())for(const t of this.analytics)t.showRewardedVideoAd(this.placement)}receiveVideoReward(){if(this.isActive())for(const t of this.analytics)t.receiveVideoReward(this.placement)}loadRewardedInterstitialAd(){if(this.isActive())for(const t of this.analytics)t.loadRewardedInterstitialAd(this.placement)}showRewardedInterstitialAd(){if(this.isActive())for(const t of this.analytics)t.showRewardedInterstitialAd(this.placement)}receiveInterstitialReward(){if(this.isActive())for(const t of this.analytics)t.receiveInterstitialReward(this.placement)}loadAdFail(t){if(this.isActive())for(const s of this.analytics)s.loadAdFail(t,this.placement)}showAdFail(t){if(this.isActive())for(const s of this.analytics)s.showAdFail(t,this.placement)}showingAd(t){if(this.isActive())for(const s of this.analytics)s.showingAd(t,this.placement)}getPageByKey(t){let s=t;if(s.indexOf("_")>-1){let i=s.replace(/_/g,"-");return i=i.toLowerCase(),i}let a=s.length-1,n="";for(;a>0;){n=s.charAt(a);const i=Number.isNaN(Number.parseInt(n,10)),o=n===n.toUpperCase();i&&o&&(s=`${s.slice(0,a)}-${s.slice(a)}`),a--}return s.toLowerCase()}};l(Ua,"AnalyticsPlugin");let Be=Ua;const Ba=class Ba{constructor(e){u(this,"key");this.key=e}getKey(){return this.key}};l(Ba,"BaseAudioPlayer");let je=Ba;const ja=class ja{constructor(e){u(this,"id");u(this,"isMuteAll");u(this,"masterVolume");u(this,"audioClips");this.id=e,this.masterVolume=1,this.isMuteAll=!1,this.audioClips={}}getId(){return this.id}getAudioClip(e){return this.audioClips[e]?this.audioClips[e]:null}setAudioClip(e,t){this.audioClips[e]={...this.audioClips[e],...t}}async play(e,t){const s=this.getAudioClip(e);if(s){const{audioPlayer:a}=s;this.playWithRealConfig(a,t)}else await this.loadAndPlay(e,t)}async loadAndPlay(e,t){try{const s=await this.onLoadAudio(e,t),{volume:a=1}=t||{};this.setAudioClip(e,{volume:a,audioPlayer:s}),this.playWithRealConfig(s,t)}catch(s){console.warn("playAudio",s)}}playWithRealConfig(e,t){if(t){const{volume:s=1}=t;t.volume=this.masterVolume*s}e.play(t)}pause(e){const t=this.getAudioClip(e);if(!t)return!1;const{audioPlayer:s}=t;return s.pause(),!0}resume(e){const t=this.getAudioClip(e);if(!t)return!1;const{audioPlayer:s}=t;return s.resume(),!0}stop(e){const t=this.getAudioClip(e);if(!t)return!1;const{audioPlayer:s}=t;return s.stop(),!0}stopAll(){this.callAudioPlayers("stop")}muteAll(){this.isMuteAll||(this.isMuteAll=!0,this.callAudioPlayers("mute"))}unmuteAll(){this.isMuteAll&&(this.isMuteAll=!1,this.callAudioPlayers("unmute"))}setVolume(e){this.masterVolume=e,this.callAudioPlayers("setVolume")}getVolume(){return this.masterVolume}queueAudioPlayer(e,t){try{const{audioPlayer:s,volume:a=1}=e;switch(t){case"play":s.play();break;case"pause":s.pause();break;case"resume":s.resume();break;case"stop":s.stop();break;case"mute":s.setVolume(0);break;case"unmute":case"setVolume":s.setVolume(this.masterVolume*a);break;default:throw new Error(`Unsupported function: ${t}`)}}catch(s){console.warn("queueAudioPlayer",s)}}callAudioPlayers(e){const{Object:t}=p.Utils,s=t.vals(this.audioClips);for(const a of s)this.queueAudioPlayer(a,e)}};l(ja,"BaseChannelManager");let Ke=ja;p.Plugins.Audio={BaseAudioPlayer:je,BaseChannelManager:Ke};const Ka=class Ka extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"firstChannelId");u(this,"channels",{})}addChannel(t){const s=t.getId();this.channels[s]=t,this.firstChannelId||(this.firstChannelId=s)}getChannel(t){if(t===void 0)return this.channels[this.firstChannelId];const s=this.channels[t];if(!s)throw new Error(`Channel ${t} not found`);return s}async play(t,s,a){try{await this.getChannel(a).play(t,s)}catch(n){console.warn("playSound",n)}}pause(t,s){try{this.getChannel(s).pause(t)}catch(a){console.warn("pauseSound",a)}}resume(t,s){try{this.getChannel(s).resume(t)}catch(a){console.warn("resumeSound",a)}}stop(t,s){try{this.getChannel(s).stop(t)}catch(a){console.warn("stopSound",a)}}stopAll(t){try{this.getChannel(t).stopAll()}catch(s){console.warn("stopAllSounds",s)}}mute(t){try{this.getChannel(t).muteAll()}catch(s){console.warn("mute",s)}}unmute(t){try{this.getChannel(t).unmuteAll()}catch(s){console.warn("unmute",s)}}setVolume(t,s){try{this.getChannel(s).setVolume(t)}catch(a){console.warn("setSoundVolume",a)}}getVolume(t){try{return this.getChannel(t).getVolume()}catch(s){return console.warn("getSoundVolume",s),-1}}};l(Ka,"AudioPlugin");let We=Ka;const Sr={token:"",isRequesting:!1},Wa=class Wa extends T.Plugins.BasePlugin{init(){const{storage:e}=this.game;e.addStorage("auth",Sr)}async requestToken(){const{storage:e}=this.game;try{if(e.getStorageData("auth","isRequesting")||e.getStorageData("auth","token")!=="")return;e.setStorageData("auth","isRequesting",!0);const n=(await GameSDK.player.getSignedPlayerInfoAsync()).getSignature();e.setStorageData("auth","token",n)}catch(t){if(p.Utils.Object.hasOwn(t,"code")&&t.code==="PENDING_REQUEST")return;e.setStorageData("auth","token",""),console.error(t)}finally{e.setStorageData("auth","isRequesting",!1)}}getToken(){const{storage:e}=this.game;return e.getStorageData("auth","token")}};l(Wa,"AuthPlugin");let ze=Wa;var So=(f=>(f.SOLO="solo",f.TOURNAMENT="tournament",f.SHARE_INVITE="share_invite",f.MATCHING_GROUP="matching_group_match",f.CHALLENGE_FRIEND="challenge_friend_match",f))(So||{});const pt=So,ft=fo,{Configs:br,Utils:{Array:Nr,Valid:Cr,Browser:Lr}}=p,za=class za{constructor(e){u(this,"game");this.game=e}isValidContextType(e){return["THREAD","POST","SOLO","GROUP"].indexOf(e)>=0}isValidEntryPointData(e){return Cr.isObject(e)}isTournamentEntryPoint(e){return Nr.has(["facebook~game_list~tournaments","fb_feed_tournament_unit","messenger~bot_thread~tournaments"],e)}receiveContext(e,t,s){const{storage:a}=this.game;a.setStorageData("context","contextId",e),this.isValidEntryPointData(s)?a.setStorageData("context","entryPointData",s):console.warn(`Invalid context type: ${t}`),this.isValidContextType(t)?a.setStorageData("context","contextType",t):console.warn(`Invalid context type: ${t}`)}async detectContextSessionType(){const{storage:e}=this.game,t=e.getStorageData("context","entryPointData"),{type:s}=t,{SOLO:a,TOURNAMENT:n,MATCHING_GROUP:i,SHARE_INVITE:o,CHALLENGE_FRIEND:r}=pt;let c=a;if(s===n&&(c=n),s===i&&(c=i),(s===r||s===o)&&(c=r),c===a)try{br.Core.FastCheckTournamentContext?c=this.fastCheckTournamentContext()||c:c=await this.outdatedCheckTournamentContext()||c}catch{}e.setStorageData("context","sessionContextType",c)}fastCheckTournamentContext(){const t=Lr.getQueryParams().entry_point;return typeof t!="string"||!this.isTournamentEntryPoint(t)?!1:pt.TOURNAMENT}async outdatedCheckTournamentContext(){return"getTournamentAsync"in GameSDK&&(await GameSDK.getTournamentAsync()).getEndTime()>Date.now()/1e3?pt.TOURNAMENT:!1}detectContextGameMode(){const{player:e,storage:t}=this.game,s=t.getStorageData("context","entryPointData"),a=t.getStorageData("context","sessionContextType"),n=e.getPlayerId(),{matchId:i,playerId:o,opponentId:r=Z.playerId}=s,c=n===o,h=r===Z.playerId||[r,o].indexOf(n)>=0,{TOURNAMENT:y,MATCHING_GROUP:g,SHARE_INVITE:w,CHALLENGE_FRIEND:I}=pt;let m=ft.SINGLE;a===y&&(m=ft.TOURNAMENT),a===w&&!c&&(m=ft.CHALLENGE_FRIEND),a===I&&i&&h&&(m=ft.CHALLENGE_FRIEND),a===g&&(m=ft.MATCHING_GROUP),t.setStorageData("context","contextGameMode",m)}};l(za,"Context");let He=za;const Ha=class Ha extends Error{constructor(e){super(e),this.name="PlayerHasFinishedMatch",this.message=e??"Player has finished match"}};l(Ha,"PlayerHasFinishedMatch");let oe=Ha;const qa=class qa extends Error{constructor(e){super(e),this.name="PlayerNotJoinInMatch",this.message=e||"Player is not join in match"}};l(qa,"PlayerNotJoinInMatch");let Vt=qa;const{Events:re,Plugins:{Analytics:bo}}=p,Ya=class Ya{constructor(e){u(this,"game");this.game=e}async processContextData(){const{player:e,storage:t,monitorError:s}=this.game,a=t.getStorageData("context","contextId"),n=t.getStorageData("context","entryPointData"),i=t.getStorageData("context","sessionContextType"),{type:o,matchId:r,playerId:c,opponentId:d,playerScore:h,action:y}=n||{};y&&await this.processEntryPointAction(y);const g=e.isFirstLogin();setTimeout(()=>{this.logUserAnalytics(g)},1e3);const{TOURNAMENT:w,SHARE_INVITE:I,MATCHING_GROUP:m,CHALLENGE_FRIEND:L}=pt;if(i===w)try{await this.processTournamentModeAsync(a);return}catch{s==null||s.sendException(new Error("Process Tournament Fail"),{contextId:a,isFirstLogin:g,entryPointData:n,playerData:e.getPlayerData()})}if(i===L){if(o===I&&typeof c=="string"){await this.processChallengeFromPostAsync(c);return}if(o===L&&typeof r=="string"&&typeof c=="string"&&typeof d=="string"){await this.processChallengeFromMessageAsync({contextId:a,matchId:r,playerId:c,opponentId:d});return}}if(i===m&&typeof c=="string"&&typeof h=="number"){await this.processMatchingGroupModeAsync(c,h);return}if(g){await this.processSingleModeAsync(!0),e.loggedIn();return}this.switchToDashboardScene()}logUserAnalytics(e){try{const{player:t,analytics:s}=this.game;if(e)s.event(bo.Events.NEW_USER);else{const{coins:a}=t.getPlayerData().gameData;s.event(bo.Events.RETURNING_USER,{coins:a})}}catch{}}async processEntryPointAction(e){try{const{player:t}=this.game;switch(e){case"reset_data":t.setPlayerDataByName("score",0),t.setPlayerDataByName("endlessScore",0),t.setGameData({coins:0,level:1}),await t.syncProfileToServer();break;case"enable_debug":t.setPlayerDataByName("debug",!0);break;case"set_locale_en":this.requestSetLocale("en");break;case"set_locale_ru":this.requestSetLocale("ru");break}}catch(t){console.warn("processEntryPointAction",t)}}requestSetLocale(e){const{event:t}=this.game;t.emit(re.REQUEST_LANGUAGE,{locale:e})}async processTournamentModeAsync(e){const{match:t,player:s}=this.game,a=s.getPlayerId();if(typeof e!="string")throw new Error("Cannot get contextId");await t.tournament.continue.processAsync({playerId:a,contextId:e}),this.switchToGameScene()}async processChallengeFromPostAsync(e){const{match:t,player:s}=this.game,a=s.getPlayerId();if(a===e)await t.single.start.processAsync({playerId:a});else try{await t.challenge.friend.processAsync({playerId:a,opponentId:e})}catch(i){console.warn("processChallengeFromPostAsync",i),await t.single.start.processAsync({playerId:a})}this.switchToGameScene()}async processChallengeFromMessageAsync(e){try{await this.processContinueChallengeFromMessageAsync(e)}catch(t){if(console.warn("processContinueChallengeFromMessageAsync",t),t instanceof oe){await this.processAwaitChallengeFromMessageAsync(e);return}if(t instanceof Vt){await this.processJoinChallengeFromMessageAsync(e);return}this.switchToDashboardScene()}}async processContinueChallengeFromMessageAsync(e){const{contextId:t,matchId:s,playerId:a,opponentId:n}=e,{match:i,player:o}=this.game,r=o.getPlayerId();if(a===r)await i.challenge.continue.processAsync({contextId:t,matchId:s,playerId:r,opponentId:n});else{const d=n===Z.playerId;await i.challenge.continue.processAsync({contextId:t,matchId:s,playerId:r,opponentId:d?n:a})}this.switchToGameScene()}async processJoinChallengeFromMessageAsync(e){const{contextId:t,matchId:s,playerId:a}=e,{match:n,player:i}=this.game,o=i.getPlayerId();await n.challenge.join.processAsync({contextId:t,matchId:s,playerId:o,opponentId:a}),this.switchToGameScene()}async processAwaitChallengeFromMessageAsync(e){const{contextId:t,matchId:s,playerId:a}=e,{match:n,player:i}=this.game,o=i.getPlayerId();try{await n.challenge.await.processAsync({contextId:t,matchId:s,playerId:o,opponentId:a}),this.switchToChallengeResultScene()}catch(r){console.warn("processAwaitChallengeFromMessageAsync",r),await this.processResultChallengeFromMessageAsync(e)}}async processResultChallengeFromMessageAsync(e){const{contextId:t,matchId:s,playerId:a}=e,{match:n,player:i}=this.game,o=i.getPlayerId();try{await n.challenge.result.processAsync({contextId:t,matchId:s,playerId:o,opponentId:a}),this.switchToChallengeResultScene()}catch{this.switchToDashboardScene()}}async processMatchingGroupModeAsync(e,t){const{match:s,player:a}=this.game;await s.group.join.processAsync({playerId:a.getPlayerId(),opponentId:e,opponentScore:t}),this.switchToGameScene()}async processSingleModeAsync(e){const{match:t,player:s}=this.game,a=s.getPlayerId();e&&await t.handler.setMatchCustomData({level:0}),await t.single.start.processAsync({playerId:a}),this.switchToGameScene()}switchToDashboardScene(){const{event:e}=this.game;e.emit(re.SWITCH_SCENE,{sceneName:"DashboardScene",sceneData:{isFromLoader:!0}})}switchToGameScene(){const{event:e}=this.game;e.emit(re.SWITCH_SCENE,{sceneName:"GameScene",sceneData:{isFromLoader:!0}})}switchToChallengeResultScene(){const{event:e}=this.game;e.emit(re.SWITCH_SCENE,{sceneName:"ChallengeResultScene",sceneData:{isFromLoader:!0}})}};l(Ya,"Loader");let qe=Ya;const No={processed:!1,contextId:"",contextType:"SOLO",entryPointData:{},contextGameMode:"",sessionContextType:""},{Events:Tr}=p,Qa=class Qa extends T.Plugins.BasePlugin{constructor(t){super(t);u(this,"context");u(this,"loader");this.loader=new qe(t),this.context=new He(t)}init(){const{storage:t}=this.game;t.addStorage("context",No)}getSessionContextTypes(){return pt}async processContextData(){try{await this.loader.processContextData()}catch(t){console.error("processContextData",t),this.switchToDashboardScene()}}async detectContextSessionType(){try{await this.context.detectContextSessionType()}catch(t){console.error("detectContextSessionType",t)}}detectContextGameMode(){this.context.detectContextGameMode()}receiveContext(t,s,a){this.context.receiveContext(t,s,a)}switchToDashboardScene(){const{event:t}=this.game;t.emit(Tr.SWITCH_SCENE,{sceneName:"DashboardScene"})}};l(Qa,"ContextPlugin");let Ye=Qa;const{Valid:Qe}=p.Utils,{contextId:Or,contextType:Rr,entryPointData:Mr}=No,Xe="is invalid",Xa=class Xa extends G{constructor(){super(...arguments);u(this,"data")}setupData(t){this.lazySetupData(t)}validateStructure(t){this.lazyValidateStructure(t)}validateData(t){this.lazyValidateData(t)}validateContextId(t){Qe.isString(t)||this.exception("contextId",Xe)}validateContextType(t){(!Qe.isString(t)||!t)&&this.exception("contextType",Xe)}validateEntryPointData(t){Qe.isObject(t)||this.exception("entryPointData",Xe)}toObject(){return super.toObject()}};l(Xa,"ContextInfoDtos");let ce=Xa;ce.addDefaultData({contextId:Or,contextType:Rr,entryPointData:Mr}),p.Dtos.Context={Info:ce};const _r={0:{id:1,type:"coin",value:300},1:{id:2,type:"coin",value:500},2:{id:3,type:"coin",value:1e3},3:{id:4,type:"coin",value:2e3},4:{id:5,type:"coin",value:3e3},5:{id:6,type:"coin",value:5e3},6:{id:7,type:"coin",value:1e3}},{Object:$r}=p.Utils,Ja=class Ja{async getDailyRewardsAsync(){return $r.vals(_r)}};l(Ja,"DailyRewardsAPI");let Je=Ja;const Ft={REWARDED:"rewarded",SKIPPED:"skipped",READY:"ready",WAITING:"waiting"},Gr={dailyRewards:{}},Co=p.Configs.DailyRewards,Za=class Za extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"dailyRewardsApi",new Je)}init(){const{storage:t}=this.game;t.addStorage("dailyRewards",Gr)}async requestDailyRewardsAsync(){const t=await this.dailyRewardsApi.getDailyRewardsAsync();t.length!==0&&this.receiveDailyRewards(t)}getDailyRewards(){const{storage:t}=this.game,s=t.getStorageData("dailyRewards","dailyRewards");return s||null}logLoginReward(){const{player:t}=this.game,{logDays:s}=t.getPlayerData().dailyRewarded,a=[...s];a[a.length-1]=!0,this.logDailyRewards(a)}logDailyRewards(t,s=!1){const{player:a}=this.game;a.setPlayerDataByName("dailyRewarded",{logDays:t,lastRewarded:s?0:Date.now()})}receiveDailyRewards(t){const{player:s}=this.game,{logDays:a,lastRewarded:n}=s.getPlayerData().dailyRewarded,i=new Date,o=new Date(n),r=new Date(o.toDateString()),c=Math.abs(i.valueOf()-r.valueOf()),h=Math.floor(c/864e5)>1,g=Co.CheckInterrupt&&h||a.length>=Co.MaxDays,w=g?[!1]:[...a,!1];this.logDailyRewards(w);const I=t.map((m,L)=>{const j=L<w.length,x=w.length===L+1,po=w[L]===!1;let X=Ft.WAITING;return x?X=Ft.READY:g?X=Ft.WAITING:j&&po?X=Ft.SKIPPED:j&&(X=Ft.REWARDED),{...m,status:X}});this.setDailyRewards(I)}setDailyRewards(t){const{storage:s}=this.game;s.setStorageData("dailyRewards","dailyRewards",t)}};l(Za,"DailyRewardsPlugin");let Ze=Za;var ts={exports:{}};ts.exports,function(f){var e=Object.prototype.hasOwnProperty,t="~";function s(){}l(s,"Events"),Object.create&&(s.prototype=Object.create(null),new s().__proto__||(t=!1));function a(r,c,d){this.fn=r,this.context=c,this.once=d||!1}l(a,"EE");function n(r,c,d,h,y){if(typeof d!="function")throw new TypeError("The listener must be a function");var g=new a(d,h||r,y),w=t?t+c:c;return r._events[w]?r._events[w].fn?r._events[w]=[r._events[w],g]:r._events[w].push(g):(r._events[w]=g,r._eventsCount++),r}l(n,"addListener");function i(r,c){--r._eventsCount===0?r._events=new s:delete r._events[c]}l(i,"clearEvent");function o(){this._events=new s,this._eventsCount=0}l(o,"EventEmitter"),o.prototype.eventNames=l(function(){var c=[],d,h;if(this._eventsCount===0)return c;for(h in d=this._events)e.call(d,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(d)):c},"eventNames"),o.prototype.listeners=l(function(c){var d=t?t+c:c,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var y=0,g=h.length,w=new Array(g);y<g;y++)w[y]=h[y].fn;return w},"listeners"),o.prototype.listenerCount=l(function(c){var d=t?t+c:c,h=this._events[d];return h?h.fn?1:h.length:0},"listenerCount"),o.prototype.emit=l(function(c,d,h,y,g,w){var I=t?t+c:c;if(!this._events[I])return!1;var m=this._events[I],L=arguments.length,j,x;if(m.fn){switch(m.once&&this.removeListener(c,m.fn,void 0,!0),L){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,d),!0;case 3:return m.fn.call(m.context,d,h),!0;case 4:return m.fn.call(m.context,d,h,y),!0;case 5:return m.fn.call(m.context,d,h,y,g),!0;case 6:return m.fn.call(m.context,d,h,y,g,w),!0}for(x=1,j=new Array(L-1);x<L;x++)j[x-1]=arguments[x];m.fn.apply(m.context,j)}else{var po=m.length,X;for(x=0;x<po;x++)switch(m[x].once&&this.removeListener(c,m[x].fn,void 0,!0),L){case 1:m[x].fn.call(m[x].context);break;case 2:m[x].fn.call(m[x].context,d);break;case 3:m[x].fn.call(m[x].context,d,h);break;case 4:m[x].fn.call(m[x].context,d,h,y);break;default:if(!j)for(X=1,j=new Array(L-1);X<L;X++)j[X-1]=arguments[X];m[x].fn.apply(m[x].context,j)}}return!0},"emit"),o.prototype.on=l(function(c,d,h){return n(this,c,d,h,!1)},"on"),o.prototype.once=l(function(c,d,h){return n(this,c,d,h,!0)},"once"),o.prototype.removeListener=l(function(c,d,h,y){var g=t?t+c:c;if(!this._events[g])return this;if(!d)return i(this,g),this;var w=this._events[g];if(w.fn)w.fn===d&&(!y||w.once)&&(!h||w.context===h)&&i(this,g);else{for(var I=0,m=[],L=w.length;I<L;I++)(w[I].fn!==d||y&&!w[I].once||h&&w[I].context!==h)&&m.push(w[I]);m.length?this._events[g]=m.length===1?m[0]:m:i(this,g)}return this},"removeListener"),o.prototype.removeAllListeners=l(function(c){var d;return c?(d=t?t+c:c,this._events[d]&&i(this,d)):(this._events=new s,this._eventsCount=0),this},"removeAllListeners"),o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,f.exports=o}(ts);var kr=ts.exports;const Vr=go(kr),rt=new Vr,Fr={names:[],history:[]},tn=class tn extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"enableLog",!1);u(this,"muteEvents",[])}init(){const{storage:t}=this.game;t.addStorage("event",Fr)}enableLogEvent(){this.enableLog=!0}on(t,s){this.validateCallback(s),this.addEventName(t),this.addHistory(t,"on","listening"),rt.on(t,s)}once(t,s){this.validateCallback(s),this.addEventName(t),this.addHistory(t,"once","listening"),rt.once(t,s)}catchUp(t,s){if(this.validateCallback(s),this.once(t,s),!(this.getEventEmitCount(t)>0))return;const{payload:n}=this.getLastEventInfo(t)??{};this.emit(t,n)}off(t,s){this.validateCallback(s),rt.off(t,s),this.addHistory(t,"action","removed")}mute(t){this.muteEvents.indexOf(t)>-1||this.muteEvents.push(t)}clear(t){rt.removeAllListeners(t),this.addHistory(t,"action","removed")}emit(t,s){if(this.muteEvents.indexOf(t)>-1)return;let a=[];s&&(a=[s]),this.addHistory(t,"action","called",s),rt.emit(t,...a)}validateCallback(t){if(typeof t!="function")throw new Error("Callback must be a function")}addEventName(t){const{storage:s}=this.game,a=s.getStorageData("event","names");a.indexOf(t)<0&&a.push(t)}getEventListeners(){const t=rt.eventNames();return Object.keys(t)}getHistory(){const{storage:t}=this.game;return t.getStorageData("event","history")}getEventEmitCount(t){return this.getHistory().filter(a=>a.name===t&&a.status==="called").length}getLastEventInfo(t){const s=this.getHistory();let a=null;for(let n=s.length-1;n>=0;n--)if(s[n].name===t){a=s[n];break}return a}getTypeFromHistory(t){const s=this.getLastEventInfo(t);return(s==null?void 0:s.type)??null}getCallsFromHistory(t){const s=this.getLastEventInfo(t);return(s==null?void 0:s.called)??0}addHistory(t,s,a,n){const o=this.getTypeFromHistory(t)??s,r=this.getCallsFromHistory(t),c=a==="called"?r+1:r;this.getHistory().push({type:o,status:a,name:t,called:c,payload:n??{}}),this.logEventInfo(t,o,a,c)}logEventInfo(t,s,a,n){if(this.enableLog){if(a==="listening"){console.info(`Event (${s}) ${t}: ${a}`);const i=rt.listenerCount(t);i>1&&console.warn(`Event ${t} has ${i} listener`)}else s!=="action"&&console.info(`Event (${s}) ${t}: ${a} (${n} times)`);a==="called"&&rt.listenerCount(t)<=0&&console.warn(`Event ${t} is called but not listening`)}}};l(tn,"EventPlugin");let es=tn;const ss={},Ut=Object.freeze(Object.defineProperty({__proto__:null,default:ss},Symbol.toStringTag,{value:"Module"})),Ur='nunito,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif',{Configs:Br,Utils:jr}=p,{Object:as}=jr,{Enabled:Kr,WideframeConfigs:ns}=Br.FrameCapture,Wr=l(async f=>{if(!Kr)return console.warn("FrameCapture is not enabled"),null;const e=Hr(f);if(!e)return null;zr(e,ns.ResultChallenge);const{frameCapture:t}=window.game,{Width:s,Height:a}=ns.ResultChallenge;return t.captureAsync({name:"ResultChallenge",width:s,height:a,renderOptions:e})},"renderResultChallenge"),zr=l((f,e)=>{const{Width:t,Height:s,Wideframe:a}=e;f.wideframe={name:"result-challenge",type:"image",depth:0,image:a,size:[t,s],position:[0,0]}},"addWideframe$2"),Hr=l(f=>{try{const{playerId:e="10",playerPhoto:t="",playerScore:s=0,opponentId:a="20",opponentPhoto:n="",opponentScore:i=0,isPlayerFinished:o,isOpponentFinished:r}=f,{RenderOptions:c}=ns.ResultChallenge,d=as.clone(c);if(!d)return null;const h=as.clear(d),y=as.camelCaseKeys(h),{playerPhoto:g,opponentPhoto:w}=y,I=s===i,m=s>i,L=o??r,j=o&&r;return g.type==="image"&&(g.name=`${e}`,g.image=t),w.type==="image"&&(w.name=`${a}`,w.image=n),L&&qr(y,{playerScore:s,opponentScore:i,isPlayerFinished:o,isOpponentFinished:r}),!j||I?(delete y.leftCrown,delete y.rightCrown,y):(m?delete y.rightCrown:delete y.leftCrown,y)}catch(e){return console.warn("getRenderOptionsShareScore",e),null}},"getRenderOptions$2"),qr=l((f,e)=>{const{leftScore:t,rightScore:s}=f,{playerScore:a=0,opponentScore:n=0,isPlayerFinished:i,isOpponentFinished:o}=e;(t==null?void 0:t.type)==="text"&&(t.text=i?`${a}`:"???"),(s==null?void 0:s.type)==="text"&&(s.text=o?`${n}`:"???")},"addRenderScores"),{Configs:Yr,Utils:Qr}=p,{Object:is}=Qr,{Enabled:Xr,WideframeConfigs:os}=Yr.FrameCapture,Jr=l(async f=>{if(!Xr)return console.warn("FrameCapture is not enabled"),null;const e=tc(f);if(!e)return null;Zr(e,os.ShareLeaderboard);const{frameCapture:t}=window.game,{Width:s,Height:a}=os.ShareLeaderboard;return t.captureAsync({name:"ShareLeaderboard",width:s,height:a,renderOptions:e})},"renderShareLeaderboard"),Zr=l((f,e)=>{const{Width:t,Height:s,Wideframe:a}=e;f.wideframe={name:"share-leaderboard",type:"image",depth:0,image:a,size:[t,s],position:[0,0]}},"addWideframe$1"),tc=l(f=>{try{const{playerId:e,playerPhoto:t,leaders:s}=f,{RenderOptions:a}=os.ShareLeaderboard,n=is.clone(a);if(!n)return null;const i=is.clear(n),o=is.camelCaseKeys(i),{avatar:r}=o;return r.type==="image"&&(r.name=`${e}`,r.image=t),ec(o,s),o}catch(e){return console.warn("getRenderOptionsShareScore",e),null}},"getRenderOptions$1"),ec=l((f,e)=>{const t="600 48px";e.forEach((s,a)=>{const{id:n,name:i,photo:o,score:r}=s;let c=1294+180*a;f[`photo_${n}`]={depth:-1,name:n,type:"image",image:o,size:[96,96],position:[436,c]},c=1360+180*a,f[`name_${n}`]={font:t,depth:1,name:n,type:"text",text:i,position:[600,c]},f[`score_${n}`]={font:t,depth:1,name:n,type:"text",text:`${r}`,position:[100,c]}})},"addLeaders"),{Configs:sc,Utils:ac}=p,{Object:rs}=ac,{Enabled:nc,WideframeConfigs:cs}=sc.FrameCapture,ic=l(async f=>{if(!nc)return console.warn("FrameCapture is not enabled"),null;const e=rc(f);if(!e)return null;oc(e,cs.ShareScore);const{frameCapture:t}=window.game,{Width:s,Height:a}=cs.ShareScore;return t.captureAsync({name:"ShareScore",width:s,height:a,renderOptions:e})},"renderShareScore"),oc=l((f,e)=>{const{Width:t,Height:s,Wideframe:a}=e;f.wideframe={name:"share-score",type:"image",depth:0,image:a,size:[t,s],position:[0,0]}},"addWideframe"),rc=l(f=>{try{const{playerId:e,playerPhoto:t,playerScore:s}=f,{RenderOptions:a}=cs.ShareScore,n=rs.clone(a);if(!n)return null;const i=rs.clear(n),o=rs.camelCaseKeys(i);console.log("renderOptions",o);const{avatar:r,playerScore:c}=o;return r.type==="image"&&(r.name=`${e}`,r.image=t),c.type==="text"&&(c.text=`${s}`),o}catch(e){return console.warn("getRenderOptionsShareScore",e),null}},"getRenderOptions"),{Configs:cc,Utils:lc}=p,{Image:le,Object:Bt,Valid:de}=lc,{Options:ls}=cc.FrameCapture,en=class en extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"width");u(this,"height");u(this,"canvas",null);u(this,"testRenderOptions",null);u(this,"caches",{});u(this,"wideframe",{})}init(){this.addWideframeRender("renderShareScore",ic),this.addWideframeRender("renderResultChallenge",Wr),this.addWideframeRender("renderShareLeaderboard",Jr)}async preloadAsync(t){const{renderOptions:s}=t;await this.loadImages(s)}async captureAsync(t){const{width:s,height:a,renderOptions:n}=t;return await this.loadImages(n),this.width=s,this.height=a,this.createCanvas(),this.drawObjects(n),this.snapshotFrameAsync()}addWideframeRender(t,s){this.wideframe[t]=s}setTestRenderOptions(t){if(!t){this.testRenderOptions=null;return}const s=Bt.camelCaseKeys(t);this.testRenderOptions=Bt.merge(this.testRenderOptions,s)}createCanvas(){if(this.canvas){const t=this.canvas.getContext("2d");t?t.clearRect(0,0,this.canvas.width,this.canvas.height):this.canvas=null}this.canvas||(this.canvas=document.createElement("canvas",{is:"canvas"})),this.canvas.width=this.width,this.canvas.height=this.height}async loadImages(t){const s=Bt.vals(t).filter(o=>o.type==="image"),a=this.prepareLoadImages(s),n=Bt.vals(a);if(n.length<1)return;const i=await Promise.all(n);this.cacheImages(a,i)}prepareLoadImages(t){const s={};for(const a of t){const{name:n,image:i,fallbackImage:o}=a,r=this.caches[n];!de.isString(i)||r||(i===""&&de.isString(o)&&(a.image=o),console.info("prepareLoadImages",a),s[n]=new Promise(c=>{le.loadImage(i).then(h=>{c(h)}).catch(()=>{de.isString(o)?(a.image=o,le.loadImage(a.image).then(h=>{c(h)}).catch(()=>{c(null)})):c(null)})}))}return s}cacheImages(t,s){for(const a in t){const n=s.shift();n&&(this.caches[a]=n)}}drawObjects(t){const s=Bt.vals(t).sort((a,n)=>a.depth-n.depth);for(const a of s)switch(a.type){case"text":this.drawText(a);break;case"image":this.drawImage(a);break}}drawText(t){if(!this.canvas)return;const s=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!0});if(!s)return;const{position:a,font:n,text:i,color:o,lineWidth:r,textAlign:c}=t;s.font=`${n} ${Ur}`,s.fillStyle=o??"#ffffff",r&&(s.lineWidth=r),c&&(s.textAlign=c),console.info("drawText",t);const[d,h]=a;s.fillText(i,d,h)}drawImage(t){if(!this.canvas)return;const s=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!0});if(!s)return;const{name:a,size:n,position:i,fallbackImage:o}=t;let r=this.caches[a];if(!r&&o&&(r=this.caches[o]),!r)throw new Error(`Image ${a} not found`);console.info("drawImage",t);const[c,d]=i,[h,y]=n;s.drawImage(r,c,d,h,y)}async snapshotFrameAsync(){if(!this.canvas)return null;let t=null;if(ls.UseBlobIfPossible&&"toBlob"in this.canvas?t=await this.createAsBlob():t=this.createAsDataImage(),!t)throw new Error("Image data is null");return de.isDebugger()&&le.logImage(t),t}createAsDataImage(){if(!this.canvas)return null;const t=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!0});if(!t)return null;const{Quality:s,RenderType:a}=ls;return t.canvas.toDataURL(`image/${a}`,s)}createAsBlob(){return new Promise(t=>{if(!this.canvas){t(null);return}const{Quality:s,RenderType:a}=ls;this.canvas.toBlob(n=>{if(!n){t(null);return}le.blobToDataImage(n).then(i=>{t(i)})},`image/${a}`,s)})}};l(en,"FrameCapturePlugin");let ds=en;const sn=class sn extends Error{constructor(t,s){const a=String(t);super(`Text with key "${a}" not found in locale "${s}"`);u(this,"key");u(this,"locale");this.name="MissingKeyInLocaleError",this.key=a,this.locale=s}};l(sn,"MissingKeyInLocaleError");let jt=sn;const an=class an extends Error{constructor(t){super(`Locale "${t}" not found`);u(this,"locale");this.name="LocaleNotFoundError",this.locale=t}};l(an,"LocaleNotFoundError");let he=an;const{Utils:{Object:hs,Function:Lo}}=p,nn=class nn extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"locale");u(this,"fallbackLocale");u(this,"data",{})}setFallbackLocale(t){this.fallbackLocale=t}hasTextKey(t,s){const a=s??this.getCurrentLocale(),{text:n}=this.getLocaleData(a);return hs.hasOwn(n,t)}hasTextureKey(t,s){const a=s??this.getCurrentLocale(),{texture:n}=this.getLocaleData(a);return hs.hasOwn(n,t)}add(t,s,a=!1){this.data[t]=s,a&&this.setFallbackLocale(t)}choose(t){this.locale=t;const{event:s}=this.game;s.emit(p.Events.LANGUAGE_CHANGED,{locale:t})}getText(t,s,a,n=!1){try{return this.uncaughtGetText(t,s,a,!n)}catch(i){return i instanceof jt||i instanceof he?console.warn(i.message):console.error(i),String(t)}}getTexture(t,s,a=!1){return this.uncaughtGetTexture(t,s,!a)}uncaughtGetText(t,s=[],a,n=!0){if(!n||this.fallbackLocale===void 0){const r=this.getRawText(t,a??this.getCurrentLocale());return this.replaceVariables(r,s)}const i=this.fallbackLocale,o=Lo.retry(()=>this.getRawText(t,a??this.getCurrentLocale()),()=>this.getRawText(t,i));return this.replaceVariables(o,s)}getRawText(t,s){if(!this.hasTextKey(t,s))throw new jt(t,s);const{text:a}=this.getLocaleData(s);return a[t]}uncaughtGetTexture(t,s,a=!0){if(!a||this.fallbackLocale===void 0)return this.getRawTexture(t,s??this.getCurrentLocale());const n=this.fallbackLocale;return Lo.retry(()=>this.getRawTexture(t,s??this.getCurrentLocale()),()=>this.getRawTexture(t,n))}getRawTexture(t,s){if(!this.hasTextureKey(t,s))throw new jt(t,s);const{texture:a}=this.getLocaleData(s);return a[t]}getCurrentLocale(){return this.locale??"en"}getLocaleData(t){const s=t??this.getCurrentLocale();if(!hs.hasOwn(this.data,s))throw new he(s);return this.data[s]}replaceVariables(t,s){const a=s.length;if(a===0)return t;let n=t;for(let i=0;i<a;i++){const o=s[i],r=`%{${i}}`;n=n.replace(r,o)}return n}};l(nn,"LanguagePlugin");let us=nn;const dc={_id:"",name:"",createdBy:"",description:"",expireTime:7*24*60*60*1e3,type:"app_leaderboard",timezone:"utc+0",createdAt:"2024-01-01T09:00:00.000Z",sortOrder:"desc",statistics:"max",resettable:"manually",resetScore:0,numberOfLeaders:15,amountPlayer:15},{Configs:hc,Utils:uc}=p,{Object:Kt,String:To,Valid:Oo}=uc,{OtherHost:Wt,Mockup:zt,AppId:yc}=hc,on=class on{constructor(){u(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const e=(await it(async()=>{const{default:t}=await Promise.resolve().then(()=>Ut);return{default:t}},void 0,N.meta.url)).default;if(typeof e!="function")throw new Error("Cannot load LeaderboardAPIMock");this.mockAPI=new e}async getLeadersAsync(e,t,s){const a=To.params(s);let n;return zt.Leaderboards.Enabled?(await this.initMockAPI(),"playerIds"in s?n=await this.mockAPI.getPlayers(e,s):n=await this.mockAPI.getLeaders(e,s)):n=await ut(`${t}?${a}`,{},Wt),!Kt.hasOwn(n,"data")||!Array.isArray(n.data)?[]:n.data}async getLeaderboardAsync(e){let t;const s=`leaderboards/${e}`;return zt.Leaderboards.Enabled?(await this.initMockAPI(),t=await this.mockAPI.getLeaderboardAsync(e)):(t=await ut(s,{},Wt),Kt.hasOwn(t,"data")&&Oo.isObject(t.data)&&(t=t.data)),t}async getLeaderboardsAsync(e){let t;const s=p.Utils.String.params(e);return zt.Leaderboards.Enabled?(await this.initMockAPI(),t=await this.mockAPI.getLeaderboardsAsync(e)):(t=await ut(`leaderboards?${s}`,{},Wt),Kt.hasOwn(t,"data")&&Array.isArray(t.data)?t=t.data:t=[]),t}async setLeaderboardScoreAsync(e){const{leaderboardId:t,playerId:s,score:a}=e;zt.Leaderboards.Enabled?(await this.initMockAPI(),await this.mockAPI.setScoreAsync(t,s,a)):await k(`leaderboards/${t}/players/${s}`,{score:a},{},Wt)}async createLeaderboardAsync(e){const t=e._id??To.generateObjectId(),s=e.numberOfLeaders,a={...dc,...e,_id:t,appId:yc,numberOfLeaders:s},n="leaderboards";let i;if(zt.Leaderboards.Enabled?(await this.initMockAPI(),i=await this.mockAPI.createLeaderboard(a)):(i=await k(n,a,{},Wt),Kt.hasOwn(i,"data")&&Oo.isObject(i.data)&&(i=i.data)),!Kt.hasOwn(i,"_id")||i._id!==t)throw new Error("Create leaderboard failed");return t}};l(on,"LeaderboardAPI");let ys=on;const Ro={limit:0,offset:0,leaders:{},isRequesting:!1,amountPlayer:0},pc={leaderboards:{}},{Array:fc,Valid:gc,Json:Mo,Object:ue}=p.Utils,rn=class rn extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"lbAPI",new ys);u(this,"configs")}init(){const{storage:t}=this.game;t.addStorage("leaderboard",pc),this.configs={}}addLeaderboard(t){const{name:s,type:a,leaderboardId:n,autoSortRank:i}=t;if(this.getLeaderboard(s)){console.warn(`Leaderboard with name ${s} already exists`);return}let r=`leaderboards/${n}/`;(a==="global"||a==="tournament")&&(r+="leaders"),a==="friends"&&(r+="players"),this.configs[s]={id:n,name:s,type:a,host:r,autoSortRank:i};const c=Mo.clone(Ro);this.setLeaderboard(s,{...c})}async requestLeaderboardsAsync(t){try{return await this.lbAPI.getLeaderboardsAsync(t)}catch(s){return console.warn("requestGlobalLeaderboardsAsync",s),[]}}async requestLeaderboardAsync(t,s){try{this.validateLeaderboard(t),this.clearLeaderboard(t),this.setLeaderboard(t,{isRequesting:!0});const{id:a,type:n,host:i}=this.configs[t];let o=[];if(n==="friends"){const{player:r}=this.game,c=r.getPlayerId(),d=r.getConnectedPlayerIds(s,0),h=[c,...d];this.configs[t].playerIds=[...h],o=await this.lbAPI.getLeadersAsync(a,i,{playerIds:h})}else o=await this.lbAPI.getLeadersAsync(a,i,{limit:s,offset:0});if(o.length===0)return;await this.receiveLeaderboardAsync(t,o),this.setLeaderboard(t,{limit:s,offset:0})}finally{const a=await this.lbAPI.getLeaderboardAsync(this.configs[t].id),n=a?a.resettable:"",i=a?a.amountPlayer:0;this.setLeaderboard(t,{isRequesting:!1,resettable:n,amountPlayer:i})}}async loadMoreLeaderboardAsync(t,s){const a=this.getLeaderboard(t);if(a){if(this.configs[t].type==="friends"){console.warn("Cannot load more leaderboard with type friend");return}try{this.setLeaderboard(t,{isRequesting:!0});const{id:n,host:i}=this.configs[t],{offset:o,limit:r}=a,c=o+r,d=await this.lbAPI.getLeadersAsync(n,i,{limit:s,offset:c});if(d.length===0)return;this.receiveLeaderboardAsync(t,d),this.setLeaderboard(t,{limit:s,offset:c})}finally{this.setLeaderboard(t,{isRequesting:!1})}}}getLeaderboard(t){const{storage:s}=this.game,a=s.getStorageData("leaderboard","leaderboards");return a[t]?a[t]:null}async getLeadersByPlayerIdsAsync(t,s){try{this.validateLeaderboard(t);const{id:a}=this.configs[t],n=`leaderboards/${a}/players`,i=await this.lbAPI.getLeadersAsync(a,n,{playerIds:s});return i.length===0?[]:this.toLeaders(i)}catch(a){return console.warn(a),[]}}async getLeaderboardResponseAsync(t){return await this.lbAPI.getLeaderboardAsync(t)}clearLeaderboard(t){try{this.validateLeaderboard(t);const s=Mo.clone(Ro);this.setLeaderboard(t,null),this.setLeaderboard(t,{...s})}catch(s){console.warn(s)}}isLeaderboardEmpty(t){const s=this.getLeaderboard(t);if(!s)return!0;const{leaders:a}=s;return Object.keys(a).length===0}isExistLeaderboardId(t){const{configs:s}=this;return ue.vals(s).some(a=>a.id===t)}getLeaderboardName(t){const{configs:s}=this,a=fc.search(ue.vals(s),n=>n.id===t);return a?a.name:null}async setLeaderboardScoreAsync(t,s,a){try{this.validateLeaderboard(t);const{id:n}=this.configs[t],i=await this.getLastScoreOnLeaderboard(t,s);if(i&&a<=i)return;await this.lbAPI.setLeaderboardScoreAsync({leaderboardId:n,playerId:s,score:a})}catch(n){console.warn(n)}}async getLastScoreOnLeaderboard(t,s){const a=await this.getLeadersByPlayerIdsAsync(t,[s]);return a.length===0?null:a[0].score}async createLeaderboardAsync(t){return this.lbAPI.createLeaderboardAsync(t)}validateLeaderboard(t){const s=this.getLeaderboard(t);if(!gc.isObject(s))throw new Error(`Leaderboard with name ${t} not found`)}setLeaderboard(t,s){const{storage:a}=this.game;a.setStorageData("leaderboard","leaderboards",{[t]:s})}async receiveLeaderboardAsync(t,s){this.validateLeaderboard(t);const n=(await this.toLeaders(s)).filter(h=>h.name&&h.photo),{offset:i=0,leaders:o={}}=this.getLeaderboard(t)??{},r=n.filter(h=>!o[h.playerId]);if(i>0&&r.length>0){const h=ue.vals(o);r.unshift(...h)}let c=r.sort((h,y)=>y.score-h.score);this.configs[t].autoSortRank&&(c=c.map((h,y)=>({...h,rank:y+1})));const d=ue.keyBy(c,"playerId");this.setLeaderboard(t,{leaders:d})}async toLeaders(t){const{profile:s}=this.game,a=t.map(r=>r.playerId);await s.requestProfiles(a);const n=s.getProfiles();return t.map(r=>{const{playerId:c}=r,d=n[c];return d?{...r,name:d.name,photo:d.photo}:{...r,name:"Nameless",photo:"default"}}).map(r=>({...r,score:Number.parseInt(r.score,10)}))}};l(rn,"LeaderboardPlugin");let ps=rn;const cn=class cn{constructor(){u(this,"APIHost")}setAPIHost(e){this.APIHost=e}getAPIHost(){return this.APIHost}};l(cn,"BaseAPI");let fs=cn;const{Utils:_o}=p,ln=class ln extends fs{async createSingleMatchAsync(e){const s=await k("single-matches",e,{},this.getAPIHost());return this.returnValidMatchData(s)}async getSingleMatchDetailAsync(){const t=await ut("single-matches/active",{},this.getAPIHost());return this.returnValidMatchData(t)}async updateSingleMatchMoveAsync(e,t){const s=`single-matches/${e}/move`,a=await k(s,t,{},this.getAPIHost());return this.returnValidMatchData(a)}async finishSingleMatchAsync(e){const t=`single-matches/${e}/finish`,s=await k(t,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async createEndlessMatchAsync(e){const s=await k("endless-matches",e,{},this.getAPIHost());return this.returnValidMatchData(s)}async getEndlessMatchDetailAsync(){const t=await ut("endless-matches/active",{},this.getAPIHost());return this.returnValidMatchData(t)}async updateEndlessMatchMilestoneAsync(e,t){const s=`endless-matches/${e}/milestone`,a=await k(s,t,{},this.getAPIHost());return this.returnValidMatchData(a)}async finishEndlessMatchAsync(e){const t=`endless-matches/${e}/finish`,s=await k(t,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async createMatchAsync(e){const s=await k("matches",e,{},this.getAPIHost());return this.returnValidMatchData(s)}async joinMatchAsync(e){const t=`matches/${e}/join`,s=await k(t,{},{},this.getAPIHost());return this.returnValidMatchData(s)}async getMatchDetailByIdAsync(e){const t=`matches/${e}`,s=await ut(t,{},this.getAPIHost());return this.returnValidMatchData(s)}async finishMatchAsync(e){const{matchId:t="",score:s=0,level:a=0,extraData:n={}}=e,i=`matches/${t}/finish`,o=await k(i,{matchId:t,score:s,level:a,extraData:n},{},this.getAPIHost());return this.returnValidMatchData(o)}returnValidMatchData(e){let t={};return!_o.Valid.isObject(e)||!_o.Object.hasOwn(e,"data")||(t=e.data),t}};l(ln,"MatchAPI");let gs=ln;const dn=class dn{constructor(e){u(this,"matchAPI");this.createAPI(),this.setAPIConfig(e)}createAPI(){this.matchAPI=new gs}setAPIConfig(e){e.matchAPIHost&&this.matchAPI.setAPIHost(e.matchAPIHost)}setMatchAPIInstance(e){this.matchAPI=e}getMatchAPI(){return this.matchAPI}};l(dn,"APIHandler");let ws=dn;const hn=class hn{constructor(e,t){u(this,"game");u(this,"match");this.game=e,this.match=t}startLog(e){this.match.useCPUProfile&&console.profile(this.constructor.name),console.group(` ${this.constructor.name}`),e&&console.log(" ? Payload:",e)}endLog(){console.groupEnd(),this.match.useCPUProfile&&console.profileEnd()}async processAsync(e){throw new Error("Not implemented")}};l(hn,"BaseConcrete");let P=hn;const un=class un extends H{constructor(e){super(e),this.name="LevelNotDefined",this.message=e??"Level is not defined"}};l(un,"LevelNotDefined");let ye=un;const yn=class yn extends H{constructor(e){super(e),this.name="MatchModeNotDefined",this.message=e??"Match id is not defined"}};l(yn,"MatchModeNotDefined");let Ht=yn;const{Object:ms,Valid:wc}=p.Utils,pn=class pn{constructor(e){u(this,"game");u(this,"match");u(this,"nextHandler");this.game=e.game,this.match=e.match,this.nextHandler=null}setNext(e){return this.nextHandler=e,e}async processAsync(e){console.groupCollapsed(` ${this.constructor.name}`),this.logData("Before",e)}async nextAsync(e){this.logData("After",e),console.groupEnd(),this.nextHandler&&await this.nextHandler.processAsync(e)}logData(e,t){if(!wc.isDebugger())return;console.groupCollapsed(` MatchState: ${e}`);const{profiles:s,customData:a,...n}=t;console.info(" Base"),console.table(ms.clone(n)),console.info(" Profile"),console.table(ms.clone(s)),console.info(" Custom"),console.table(ms.clone(a)),console.groupEnd()}};l(pn,"BaseHandler");let A=pn;const{Plugins:mc,Utils:Ac}=p,{Analytics:Ic}=mc,{String:$o,Valid:Go}=Ac,fn=class fn extends A{async processAsync(e){super.processAsync(e);const{mode:t,customData:s}=e,{level:a}=s;this.validateMode(t),this.validateLevel(a);const{analytics:n}=this.game;n.event(Ic.Events.MATCH_START,{level:a,game_mode:$o.toUpperCamelCase(t),level_name:this.getLevelName(a)}),await this.nextAsync(e)}validateMode(e){if(!Go.isString(e))throw new Ht}validateLevel(e){if(!Go.isNumber(e))throw new ye}getLevelName(e){return`Level ${$o.padStart(e.toString(),5,"0")}`}};l(fn,"LogMatchStartHandler");let F=fn;const U={OPEN:"open",ACTIVE:"active",FINISHED:"finished"},gn=class gn extends A{async processAsync(e){super.processAsync(e);const{mode:t,status:s}=e;let a=t??ft.SINGLE;s===U.FINISHED&&(a=ft.SINGLE),this.contextGameModeDetected(a),await this.nextAsync(e)}contextGameModeDetected(e){const{storage:t}=this.game;t.setStorageData("context","contextGameMode",e)}};l(gn,"ContextGameModeHandler");let C=gn;const wn=class wn extends Error{constructor(e){super(e),this.name="GetMatchDetailFailed",this.message=e??"Get match detail failed"}};l(wn,"GetMatchDetailFailed");let qt=wn;const mn=class mn extends Error{constructor(e){super(e),this.name="MatchAreNotActive",this.message=e??"Match are not active"}};l(mn,"MatchAreNotActive");let pe=mn;const An=class An extends H{constructor(e){super(e),this.name="MatchIdNotValid",this.message=e??"Match id is not valid"}};l(An,"MatchIdNotValid");let Y=An;const In=class In extends Error{constructor(e){super(e),this.name="OpponentHasFinishedMatch",this.message=e||"Opponent has finished match"}};l(In,"OpponentHasFinishedMatch");let As=In;const Dn=class Dn extends H{constructor(e){super(e),this.name="OpponentIdNotValid",this.message=e??"Opponent id is not valid"}};l(Dn,"OpponentIdNotValid");let M=Dn;const Pn=class Pn extends Error{constructor(e){super(e),this.name="PlayerNotCurrentInMatch",this.message=e??"The player is not currently in this match"}};l(Pn,"PlayerNotCurrentInMatch");let Yt=Pn;const En=class En extends Error{constructor(e){super(e),this.name="PlayerNotFinishedMatch",this.message=e||"Player not finished match"}};l(En,"PlayerNotFinishedMatch");let fe=En;const{Dtos:Dc}=p,xn=class xn extends A{async processAsync(e){super.processAsync(e),this.validateMatchData(e);const t=await this.getMatchAsync(e),s=new Dc.Match.Data(t).toObject();this.validateAwaitMatchData(e,s),this.updateMatchData(e,s),this.validateMatchStatus(e),this.validatePlayerTurn(e),this.validateOpponentTurn(e),await this.nextAsync(e)}validateMatchData(e){const{id:t}=e;if(typeof t!="string")throw new Y}validateMatchStatus(e){const{status:t}=e;if(t!==U.ACTIVE)throw new pe}validateAwaitMatchData(e,t){const{id:s,customData:a}=e,{_id:n,whitePlayerId:i,blackPlayerId:o}=t;if(typeof n!="string"||n!==s)throw new qt;const{playerId:r}=a,c=i===r,d=o===r;if(!c&&o===Z.playerId)throw new Vt;if(!c&&!d)throw new Yt}validatePlayerTurn(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(typeof a!="string")throw new D;const{finished:n}=t[a];if(!n)throw new fe}validateOpponentTurn(e){const{profiles:t,customData:s}=e,{opponentId:a}=s;if(typeof a!="string")throw new M;const{finished:n}=t[a];if(n)throw new As}async getMatchAsync(e){const{id:t}=e;return t?this.match.api.getMatchAPI().getMatchDetailByIdAsync(t):{}}updateMatchData(e,t){const{customData:s}=e,{whitePlayerId:a,blackPlayerId:n,whitePlayerScore:i,blackPlayerScore:o,whitePlayerFinish:r,blackPlayerFinish:c,status:d}=t;e.status=d;const h=a===s.playerId,y=h?a:n,g=h?n:a;e.customData.playerId=y,e.customData.opponentId=g,e.profiles[y]||(e.profiles[y]={id:y,name:"",photo:"",finished:!1}),e.profiles[g]||(e.profiles[g]={id:g,name:"",photo:"",finished:!1});const w=h?i:o,I=h?o:i;e.profiles[y].score=w,e.profiles[g].score=I;const m=h?r:c,L=h?c:r;e.profiles[y].finished=m,e.profiles[g].finished=L}};l(xn,"AwaitMatchHandler");let Is=xn;const Ds={level:1,rescued:0,contextId:null,playerId:null,opponentId:null,tournamentId:null,leaderboardId:null},vn=class vn extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.initializeMatch(t),await this.nextAsync(t)}initializeMatch(t){const{id:s,mode:a,customData:n}=this.payload;t.id=s??null,t.mode=a||null,t.status=U.OPEN,t.startAt=0,t.finishAt=0,t.profiles={},t.customData={...Ds,...t.customData,...n}}};l(vn,"PrepareMatchHandler");let _=vn;const gt=pt,Sn=class Sn extends Error{constructor(e){super(e),this.name="UnavailableFeature",this.message=`Unavailable feature: ${e}`}};l(Sn,"UnavailableFeature");let E=Sn;const bn=class bn extends H{constructor(e){super(e),this.name="ContextIdNotValid",this.message=e??"Context id is not valid"}};l(bn,"ContextIdNotValid");let K=bn;const Nn=class Nn extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createWideframesAwaitingAsync(e);t&&this.sendMessageAsync(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesAwaitingAsync(e){try{const{frameCapture:t}=this.game,{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const o=s[n],r=s[i],{photo:c,score:d=0,finished:h}=o;if(!h)return null;const{photo:y,score:g=0,finished:w}=r;return w?null:await t.wideframe.renderResultChallenge({playerId:n,playerPhoto:c,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!0,isOpponentFinished:!1})}catch(t){return console.warn("createWideframesAwaitingAsync",t),null}}async sendMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:r}=a[i],c={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${r} is waiting for you to finish this game. Play now!`,localizations:{vi_VN:`${r} ang ch bn kt thc trn u. Chi ngay!`}},image:t,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(c)}};l(Nn,"SendAwaitingMessageHandler");let Ps=Nn;const Cn=class Cn extends A{async processAsync(e){await this.nextAsync(e)}async nextAsync(e){this.nextHandler&&await this.nextHandler.processAsync(e)}};l(Cn,"NothingHandler");let v=Cn;const Ln=class Ln extends H{constructor(e){super(e),this.name="ProfileNotFound",this.message=e??"Profile not found"}};l(Ln,"ProfileNotFound");let B=Ln;const{Dtos:Pc}=p,Tn=class Tn extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const{customData:t}=e,{playerId:s,opponentId:a}=t;let n=s;const i=await this.getProfile(n);if(!i)throw new B;if(this.updateMatchProfile(e,n,i),n=a,n!==Z.playerId){const o=await this.getProfile(n);if(!o)throw new B;this.updateMatchProfile(e,n,o)}else this.updateMatchProfile(e,n);await this.nextAsync(e)}validateData(e){const{customData:t}=e,{playerId:s,opponentId:a}=t;if(!s||typeof s!="string")throw new D;if(!a||typeof a!="string")throw new M}async getProfile(e){const{profile:t}=this.game;return await t.requestProfiles([e]),t.getProfiles()[e]}updateMatchProfile(e,t,s){const{name:a,photo:n}=s??Z,i=new Pc.Match.Profile({id:t,name:a,photo:n}).toObject();e.profiles[t]?(e.profiles[t].name=i.name,e.profiles[t].photo=i.photo):e.profiles[t]=i}};l(Tn,"GetMatchProfilesHandler");let J=Tn;const On=class On extends P{async processAsync(e){try{this.startLog(e);const{matchId:t,playerId:s,opponentId:a}=e,n=new v(this),i=new _(this,{id:t,mode:$.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const o=new Is(this);i.setNext(o);const r=new J(this);o.setNext(r);const c=new Ps(this);r.setNext(c);const d=new F(this);c.setNext(d);const h=new C(this);d.setNext(h);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}};l(On,"AwaitChallengeMatchConcrete");let Es=On;const Rn=class Rn extends H{constructor(e){super(e),this.name="CreateContextFailed",this.message=e??"Create context failed"}};l(Rn,"CreateContextFailed");let Qt=Rn;const{Valid:ko,Object:Vo}=p.Utils,Mn=class Mn extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t);const{opponentId:s}=this.payload,a=await this.createAsync(s);t.customData.contextId=a,await this.nextAsync(t)}async createAsync(t){try{await GameSDK.context.createAsync(t)}catch(a){this.validateError(a)}const s=GameSDK.context.getID();if(!ko.isString(s))throw new Qt;return s}validateError(t){if(!Vo.hasOwn(t,"code"))throw t;if(t.code!=="SAME_CONTEXT"){if(t.code==="INVALID_PARAM"){if(!this.isNotConnectedPlayerError(t))throw t;return}throw t}}validateErrorMessage(t){if(!Vo.hasOwn(t,"message")||!ko.isString(t.message))throw t}isNotConnectedPlayerError(t){return this.validateErrorMessage(t),t.message.indexOf("is not a connected player of the current player")>-1}};l(Mn,"CreateContextHandler");let xs=Mn;const _n=class _n extends H{constructor(e){super(e),this.name="MatchAreNotOpen",this.message=e??"Match are not open"}};l(_n,"MatchAreNotOpen");let xt=_n;const{Dtos:Ec}=p,$n=class $n extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.validateData(t);const s=await this.createMatchAsync(t),a=new Ec.Match.Data(s).toObject();this.updateMatchState(t,a),await this.nextAsync(t)}validateData(t){const{status:s,customData:a}=t,{opponentId:n}=a;if(typeof n!="string")throw new M;if(s!==U.OPEN)throw new xt}async createMatchAsync(t){const{opponentId:s}=t.customData,{extraData:a}=this.payload;if(!s)return{};const n={opponentPlayerId:s,extraData:a};return this.match.api.getMatchAPI().createMatchAsync(n)}updateMatchState(t,s){const{customData:a}=t,{_id:n,whitePlayerId:i,blackPlayerId:o,whitePlayerFinish:r,blackPlayerFinish:c}=s,d=i===a.opponentId;t.id=n||null;const h=d?o:i,y=d?i:o;t.customData.playerId=h,t.customData.opponentId=y,t.profiles[h]||(t.profiles[h]={id:h,name:"",photo:"",finished:!1}),t.profiles[y]||(t.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?c:r,w=d?r:c;t.profiles[h].finished=g,t.profiles[y].finished=w}};l($n,"CreateMatchHandler");let ge=$n;const Gn=class Gn extends A{async processAsync(e){if(super.processAsync(e),e.status!==U.OPEN)throw new xt;this.startMatch(e),await this.nextAsync(e)}startMatch(e){e.status=U.ACTIVE,e.startAt=Date.now()}};l(Gn,"StartMatchHandler");let W=Gn;const kn=class kn extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createWideframesChallengeAsync(e);t&&this.sendMessageAsync(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesChallengeAsync(e){try{const{frameCapture:t}=this.game,{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const o=s[n],r=s[i],{photo:c,score:d=0}=o,{photo:h,score:y=0}=r;return await t.wideframe.renderResultChallenge({playerId:n,playerPhoto:c,playerScore:d,opponentId:i,opponentPhoto:h,opponentScore:y,isPlayerFinished:!1,isOpponentFinished:!1})}catch(t){return console.warn("createWideframesChallengeAsync",t),null}}async sendMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:r}=a[i],c={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${r} challenges you`,localizations:{vi_VN:`${r} th thch bn trong trn u ny. Chi ngay!`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};await GameSDK.extra.updateAsync(c)}};l(kn,"SendChallengeMessageHandler");let we=kn;const Vn=class Vn extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,opponentId:s}=e,a=new v(this),n=new xs(this,{opponentId:s});a.setNext(n);const i=new _(this,{mode:$.CHALLENGE_FRIEND,customData:{playerId:t,opponentId:s}});n.setNext(i);const o=new ge(this,{extraData:e.extraData});i.setNext(o);const r=new J(this);o.setNext(r);const c=new W(this);r.setNext(c);const d=new F(this);c.setNext(d);const h=new we(this);d.setNext(h);const y=new C(this);h.setNext(y);const g=this.match.getMatchState();await a.processAsync(g)}finally{this.endLog()}}};l(Vn,"ChallengeFriendConcrete");let vs=Vn;const Fn=class Fn extends Error{constructor(e){super(e),this.name="SameContext",this.message=e??"Same context"}};l(Fn,"SameContext");let Xt=Fn;const{Utils:Fo}=p,Un=class Un extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t);const{contextId:s}=this.payload;await this.switchAsync(s),t.customData.contextId=s,await this.nextAsync(t)}checkSameContext(t){const s=t==="SOLO",a=GameSDK.context.getID();if(a===t)throw new Xt;if(s&&a===null)throw new Xt}async switchAsync(t){const s=t==="SOLO";try{this.checkSameContext(t),await GameSDK.context.switchAsync(t,s)}catch(a){if(a instanceof Xt)return;if(!Fo.Object.hasOwn(a,"code"))throw a;if(Fo.Device.isAndroid()&&s&&a.code==="INVALID_PARAM")return;if(a.code!=="SAME_CONTEXT")throw a}}};l(Un,"SwitchContextHandler");let vt=Un;const{Dtos:xc}=p,Bn=class Bn extends A{async processAsync(e){super.processAsync(e),this.validateMatchData(e);const t=await this.getMatchAsync(e),s=new xc.Match.Data(t).toObject();this.validateContinueMatchData(e,s),this.updateMatchData(e,s),this.validatePlayerTurn(e),await this.nextAsync(e)}validateMatchData(e){const{id:t,status:s}=e;if(typeof t!="string")throw new Y;if(s!==U.OPEN)throw new xt}validateContinueMatchData(e,t){const{id:s,customData:a}=e,{_id:n,whitePlayerId:i,blackPlayerId:o}=t;if(typeof n!="string"||n!==s)throw console.warn(" ? respMatchDataValidated",t),new qt;const{playerId:r}=a,c=i===r,d=o===r;if(!c&&o===Z.playerId)throw new Vt;if(!c&&!d)throw new Yt}validatePlayerTurn(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(typeof a!="string")throw new D;const{finished:n}=t[a];if(n)throw new oe}async getMatchAsync(e){const{id:t}=e;return t?this.match.api.getMatchAPI().getMatchDetailByIdAsync(t):{}}updateMatchData(e,t){const{customData:s}=e,{whitePlayerId:a,blackPlayerId:n,whitePlayerScore:i,blackPlayerScore:o,whitePlayerFinish:r,blackPlayerFinish:c}=t,d=a===s.playerId,h=d?a:n,y=d?n:a;e.customData.playerId=h,e.customData.opponentId=y,e.profiles[h]||(e.profiles[h]={id:h,name:"",photo:"",finished:!1}),e.profiles[y]||(e.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?i:o,w=d?o:i;e.profiles[h].score=g,e.profiles[y].score=w;const I=d?r:c,m=d?c:r;e.profiles[h].finished=I,e.profiles[y].finished=m}};l(Bn,"ContinueMatchHandler");let Ss=Bn;const jn=class jn extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createWideframesCurrentScoreAsync();t&&this.sendMessageAsync(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesCurrentScoreAsync(){try{const{player:e,frameCapture:t}=this.game,{playerId:s,photo:a}=e.getPlayer(),{profiles:n}=this.match.getMatchState(),{score:i=0}=n[s]||{};return await t.wideframe.renderShareScore({playerId:s,playerPhoto:a,playerScore:i})}catch(e){return console.warn("createWideframesCurrentScoreAsync",e),null}}async sendMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:r}=a[i],c={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${r} made an update.`,localizations:{vi_VN:`${r}  cp nht trn u. Chi ngay!`}},image:t,strategy:"LAST",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(c)}};l(jn,"SendUpdateMessageHandler");let bs=jn;const Kn=class Kn extends P{async processAsync(e){try{this.startLog(e);const{contextId:t,matchId:s,playerId:a,opponentId:n}=e,i=new v(this),o=new vt(this,{contextId:t});i.setNext(o);const r=new _(this,{id:s,mode:$.CHALLENGE_FRIEND,customData:{playerId:a,opponentId:n}});o.setNext(r);const c=new Ss(this);r.setNext(c);const d=new J(this);c.setNext(d);const h=new W(this);d.setNext(h);const y=new bs(this);h.setNext(y);const g=new F(this);y.setNext(g);const w=new C(this);g.setNext(w);const I=this.match.getMatchState();await i.processAsync(I)}finally{this.endLog()}}};l(Kn,"ContinueChallengeMatchConcrete");let Ns=Kn;const{Plugins:vc,Utils:Sc}=p,{Analytics:bc}=vc,{String:Uo,Valid:Bo}=Sc,Wn=class Wn extends A{async processAsync(e){super.processAsync(e);const{customData:t,mode:s,startAt:a,finishAt:n}=e,{level:i}=t;this.validateMode(s),this.validateLevel(i);const{analytics:o}=this.game,r=Math.floor((n-a)/1e3);o.event(bc.Events.MATCH_END,{level:i,game_mode:Uo.toUpperCamelCase(s),level_name:this.getLevelName(i),time_played:r}),await this.nextAsync(e)}validateMode(e){if(!Bo.isString(e))throw new Ht}validateLevel(e){if(!Bo.isNumber(e))throw new ye}getLevelName(e){return`Level ${Uo.padStart(e.toString(),5,"0")}`}};l(Wn,"LogMatchFinishedHandler");let wt=Wn;const zn=class zn extends Error{constructor(e){super(e),this.name="ScoreNotValid",this.message=e??"Score is not valid"}};l(zn,"ScoreNotValid");let St=zn;const Hn=class Hn extends Error{constructor(e){super(e),this.name="LeaderboardIdNotValid",this.message=e??"Leaderboard id is not valid"}};l(Hn,"LeaderboardIdNotValid");let mt=Hn;const qn=class qn extends Error{constructor(e){super(e),this.name="LeaderboardNotExist",this.message=e??"Leaderboard not exist in game"}};l(qn,"LeaderboardNotExist");let Cs=qn;const{Valid:jo}=p.Utils,Yn=class Yn extends A{constructor(t,s){super(t);u(this,"payload");u(this,"leaderboardPayload");this.payload=s}async processAsync(t){super.processAsync(t),this.setupSetScorePayload(t),"submitGameResultsAsync"in GameSDK.extra&&await GameSDK.extra.submitGameResultsAsync(this.payload.score),this.setLeaderboardScoreAsync(),await this.nextAsync(t)}async setupSetScorePayload(t){const{profiles:s,customData:a}=t,{playerId:n}=a;if(!n||!s[n])throw new B;const{score:i,leaderboardId:o}=this.payload;if(!jo.isNumber(i))throw new St;if(!jo.isString(o))throw new mt;this.leaderboardPayload={score:i,playerId:n,leaderboardId:o}}async setLeaderboardScoreAsync(){try{const{playerId:t,score:s,leaderboardId:a}=this.leaderboardPayload,n=this.game.leaderboard.getLeaderboardName(a);if(!n)throw new Cs;await this.game.leaderboard.setLeaderboardScoreAsync(n,t,s)}catch(t){console.warn("setLeaderboardScoreAsync",t)}}};l(Yn,"SetLeaderboardScoreHandler");let bt=Yn;const{Valid:Nc}=p.Utils,{Leaderboards:Cc}=p.Configs,Qn=class Qn extends bt{constructor(e){super(e,{score:0,leaderboardId:Cc.LeaderboardId})}async setupSetScorePayload(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(!a||!t[a])throw new B;const{score:n}=t[a];if(!Nc.isNumber(n))throw new St;this.payload.score=n,super.setupSetScorePayload(e)}};l(Qn,"PostGlobalLeaderboardScoreHandler");let Jt=Qn;const{Dtos:Lc,Utils:Tc}=p,{Valid:me,Object:Oc}=Tc,Xn=class Xn extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.validateMatchData(t);const{useAPI:s}=this.payload;if(s){const a=await this.finishMatchAsync(t),n=new Lc.Match.Data(a).toObject();this.updateMatchFromAPI(t,n)}else this.updateMatchData(t);this.updateMatchState(t),await this.nextAsync(t)}validateMatchData(t){const{status:s,profiles:a,customData:n}=t;if(s!==U.ACTIVE)throw new pe;const{playerId:i}=n;if(!i||!Oc.hasOwn(a,i))throw new Yt}updateMatchData(t){const{playerId:s}=t.customData;if(!me.isString(s))throw new D;t.profiles[s].finished=!0}updateMatchState(t){t.status=U.FINISHED,t.finishAt=Date.now()}async finishMatchAsync(t){const{id:s,profiles:a,customData:n}=t,{level:i,playerId:o}=n;if(!me.isString(o))throw new D;const{score:r}=a[o],{extraData:c}=this.payload,d={matchId:s??"",score:r,level:i,extraData:c};return this.match.api.getMatchAPI().finishMatchAsync(d)}updateMatchFromAPI(t,s){const{playerId:a,opponentId:n}=t.customData;if(!me.isString(a))throw new D;if(!me.isString(n))throw new M;const{whitePlayerId:i,whitePlayerScore:o,blackPlayerScore:r,whitePlayerFinish:c,blackPlayerFinish:d}=s,h=a===i,y=h?o:r,g=h?r:o,w=h?c:d,I=h?d:c;t.profiles[a].score=y,t.profiles[n].score=g,t.profiles[a].finished=w,t.profiles[n].finished=I}};l(Xn,"FinishMatchHandler");let At=Xn;const Jn=class Jn extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createWideframesResultAsync(e);t&&this.progressSendFinishedMessage(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesResultAsync(e){try{const{frameCapture:t}=this.game,{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const o=s[n],r=s[i],{photo:c,score:d=0,finished:h}=o,{photo:y,score:g=0,finished:w}=r;return await t.wideframe.renderResultChallenge({playerId:n,playerPhoto:c,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!!h,isOpponentFinished:!!w})}catch(t){return console.warn("createWideframesResultAsync",t),null}}progressSendFinishedMessage(e,t){const{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||typeof n!="string")throw new D;if(!i||typeof i!="string")throw new M;const{score:o=0,finished:r}=s[n],{score:c=0,finished:d}=s[i];r?this.sendFinishMessageAsync(e,t):d&&o>c?this.sendBestScoreMessageAsync(e,t):this.sendPlayTurnMessageAsync(e,t)}async sendFinishMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:r}=a[i],c={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o,status:U.FINISHED},action:"CUSTOM",template:"finished",cta:{default:"See result",localizations:{vi_VN:"Xem kt qu"}},text:{default:`${r} just finished. Check them now.`,localizations:{vi_VN:`${r} va hon thnh mn chi. Nhn  xem kt qu trn u.`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(c)}async sendPlayTurnMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;const{name:r,score:c}=a[i],d={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o,status:U.ACTIVE},action:"CUSTOM",template:"finished",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${r} got ${c} scores. So easy! Can you?`,localizations:{vi_VN:`${r}  t ${c} im! Nhn Chi  so ti!`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(d)}async sendBestScoreMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;const{name:r,score:c}=a[i],d={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o,status:U.FINISHED},action:"CUSTOM",template:"pass_score",cta:{default:"See result",localizations:{vi_VN:"Xem kt qu"}},text:{default:`${r} beat your high score. Their score: ${c}`,localizations:{vi_VN:`${r}  vt qua im s ca bn, vi ${c} im!`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(d)}};l(Jn,"SendFinishedMessageHandler");let Ls=Jn;const Zn=class Zn extends A{async processAsync(e){super.processAsync(e),this.setPlayerBestScore(e),await this.nextAsync(e)}setPlayerBestScore(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(!a||!t[a])throw new B;const{player:n}=this.game,i=n.getBestScore()||0,{score:o=0}=t[a];o<=i||(n.setBestScore(o),t[a].bestScore=o)}};l(Zn,"SetPlayerBestScoreHandler");let Nt=Zn;const ti=class ti extends P{async processAsync(e){try{this.startLog(e);const{extraData:t}=e??{},s=new v(this),a=new At(this,{useAPI:!0,extraData:t});s.setNext(a);const n=new Ls(this);a.setNext(n);const i=new wt(this);n.setNext(i);const o=new Nt(this);i.setNext(o);const r=new Jt(this);o.setNext(r);const c=new C(this);r.setNext(c);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};l(ti,"FinishChallengeMatchConcrete");let Ts=ti;const ei=class ei extends Error{constructor(e){super(e),this.name="ContextAreSolo",this.message=e??"Context are solo"}};l(ei,"ContextAreSolo");let Os=ei;const si=class si extends Error{constructor(e){super(e),this.name="ContextNotChallenge",this.message=e??"Context is not a challenge"}};l(si,"ContextNotChallenge");let Rs=si;const ai=class ai extends Error{constructor(e){super(e),this.name="NetworkFailure",this.message=e??"Network failure"}};l(ai,"NetworkFailure");let Ms=ai;const{Utils:Rc,Dtos:Mc}=p,{Array:_c,Object:$c}=Rc,ni=class ni extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.checkCurrentContext();const s=await this.getOpponentIdFromContextAsync();t.customData.opponentId=s,await this.nextAsync(t)}checkCurrentContext(){const t=GameSDK.context.getID();if(typeof t!="string")throw new K;if(t==="SOLO")throw new Os}async getOpponentIdFromContextAsync(){const{ignoreId:t}=this.payload,s=await this.getContextPlayers([t]);if(s.length>1)throw new Rs;let a=Z;return s.length===1&&(a=s[0]),a.playerId}async getContextPlayers(t){try{const s=await GameSDK.context.getPlayersAsync(),a=[];for(const n of s){const i=n.getID();if(t.indexOf(i)>-1)continue;const o=n.getName();if(!o)continue;const r=n.getPhoto();a.push(new Mc.Player.Info({playerId:i,name:o,photo:r}).toObject())}return _c.unique(a)}catch(s){if($c.hasOwn(s,"code")&&s.code==="NETWORK_FAILURE")throw new Ms;return[]}}};l(ni,"GetOpponentChallengeContextHandler");let Ae=ni;const ii=class ii extends Error{constructor(e){super(e),this.name="ContextIsTournament",this.message=e??"Context is a tournament"}};l(ii,"ContextIsTournament");let Zt=ii;const{Object:Gc}=p.Utils,oi=class oi extends A{async processAsync(e){super.processAsync(e);const t=await this.chooseAsync();await this.checkContextTournament(),e.customData.contextId=t,await this.nextAsync(e)}async chooseAsync(){try{await GameSDK.context.chooseAsync({filters:["INCLUDE_EXISTING_CHALLENGES"],minSize:2,maxSize:2})}catch(t){if(!Gc.hasOwn(t,"code")||t.code!=="SAME_CONTEXT")throw t}const e=GameSDK.context.getID();if(typeof e!="string")throw new Qt;return e}async checkContextTournament(){try{if(!GameSDK.context.getID())return;throw"getTournamentAsync"in GameSDK?(await GameSDK.getTournamentAsync(),new Zt):new E("getTournamentAsync")}catch(e){if(e instanceof Zt)throw e}}};l(oi,"ChooseContextHandler");let _s=oi;const ri=class ri extends P{async processAsync(e){try{this.startLog(e);const{playerId:t}=e,s=new v(this),a=new _s(this);s.setNext(a);const n=new _(this,{mode:$.CHALLENGE_FRIEND,customData:{playerId:t}});a.setNext(n);const i=new Ae(this,{ignoreId:t});n.setNext(i);const o=new ge(this,{extraData:e.extraData});i.setNext(o);const r=new J(this);o.setNext(r);const c=new W(this);r.setNext(c);const d=new F(this);c.setNext(d);const h=new we(this);d.setNext(h);const y=new C(this);h.setNext(y);const g=this.match.getMatchState();await s.processAsync(g)}finally{this.endLog()}}};l(ri,"InviteFriendsConcrete");let $s=ri;const ci=class ci extends Error{constructor(e){super(e),this.name="JoinMatchFailed",this.message=e??"Join match failed"}};l(ci,"JoinMatchFailed");let Gs=ci;const li=class li extends Error{constructor(e){super(e),this.name="MatchAreFinished",this.message=e??"Match are finished"}};l(li,"MatchAreFinished");let ks=li;const di=class di extends Error{constructor(e){super(e),this.name="OtherPlayerHasJoinedMatch",this.message=e??"Other player has joined match"}};l(di,"OtherPlayerHasJoinedMatch");let Vs=di;const{Dtos:kc}=p,hi=class hi extends A{async processAsync(e){super.processAsync(e),this.validateMatchData(e);const t=await this.joinMatchAsync(e),s=new kc.Match.Data(t).toObject();this.validateJoinMatchData(e,s),this.updateMatchData(e,s),await this.nextAsync(e)}validateMatchData(e){const{status:t}=e;if(t!==U.OPEN)throw new xt}validateJoinMatchData(e,t){const{id:s,customData:a}=e,{_id:n,blackPlayerId:i,whitePlayerId:o,whitePlayerFinish:r,blackPlayerFinish:c}=t,d=i===a.playerId,h=o===a.opponentId;if(typeof n!="string"||n!==s||!h)throw console.warn(" ? matchData",t),new Gs;if(r&&c)throw new ks;if(!d)throw new Vs}async joinMatchAsync(e){const{id:t}=e;return t?this.match.api.getMatchAPI().joinMatchAsync(t):{}}updateMatchData(e,t){const{customData:s}=e,{whitePlayerId:a,blackPlayerId:n,whitePlayerScore:i,blackPlayerScore:o,whitePlayerFinish:r,blackPlayerFinish:c}=t,d=a===s.playerId,h=d?a:n,y=d?n:a;e.customData.playerId=h,e.customData.opponentId=y,e.profiles[h]||(e.profiles[h]={id:h,name:"",photo:"",finished:!1}),e.profiles[y]||(e.profiles[y]={id:y,name:"",photo:"",finished:!1});const g=d?i:o,w=d?o:i;e.profiles[h].score=g,e.profiles[y].score=w;const I=d?r:c,m=d?c:r;e.profiles[h].finished=I,e.profiles[y].finished=m}};l(hi,"JoinMatchHandler");let Fs=hi;const ui=class ui extends A{async processAsync(e){super.processAsync(e),this.validateData(e);const t=await this.createWideframesAcceptedAsync(e);t&&this.sendMessageAsync(e,t),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesAcceptedAsync(e){try{const{frameCapture:t}=this.game,{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const o=s[n],r=s[i],{photo:c,score:d=0,finished:h}=o;if(h)return null;const{photo:y,score:g=0,finished:w}=r;return w?await t.wideframe.renderResultChallenge({playerId:n,playerPhoto:c,playerScore:d,opponentId:i,opponentPhoto:y,opponentScore:g,isPlayerFinished:!1,isOpponentFinished:!0}):null}catch(t){return console.warn("createWideframesAcceptedAsync",t),null}}async sendMessageAsync(e,t){const{id:s,profiles:a,customData:n}=e,{playerId:i,opponentId:o}=n;if(!i||typeof i!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:r}=a[i],c={data:{type:gt.CHALLENGE_FRIEND,matchId:s,playerId:i,opponentId:o},action:"CUSTOM",template:"challenge",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${r} accepted the challenge.`,localizations:{vi_VN:`${r}  chp nhn tham gia trn u.`}},image:t,strategy:"LAST",notification:"PUSH"};await GameSDK.extra.updateAsync(c)}};l(ui,"SendAcceptedMessageHandler");let Us=ui;const yi=class yi extends P{async processAsync(e){try{this.startLog(e);const{matchId:t,playerId:s,opponentId:a}=e,n=new v(this),i=new _(this,{id:t,mode:$.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const o=new Fs(this);i.setNext(o);const r=new J(this);o.setNext(r);const c=new W(this);r.setNext(c);const d=new Us(this);c.setNext(d);const h=new F(this);d.setNext(h);const y=new C(this);h.setNext(y);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};l(yi,"JoinChallengeMatchConcrete");let Bs=yi;const Ko={_id:"",status:"",winnerId:"",whitePlayerId:"",blackPlayerId:"",whitePlayerScore:0,blackPlayerScore:0,whitePlayerFinish:!1,blackPlayerFinish:!1},{Valid:tt}=p.Utils,et="is invalid",pi=class pi extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateId(e){(!tt.isString(e)||!e)&&this.exception("_id",et)}validateStatus(e){(!tt.isString(e)||!e)&&this.exception("status",et)}validateWinnerId(e){e!==null&&(!tt.isString(e)||!e)&&this.exception("winnerId",et)}validateWhitePlayerId(e){(!tt.isString(e)||!e)&&this.exception("whitePlayerId",et)}validateBlackPlayerId(e){(!tt.isString(e)||!e)&&this.exception("blackPlayerId",et)}validateWhitePlayerScore(e){tt.isNumber(e)||this.exception("whitePlayerScore",et)}validateBlackPlayerScore(e){tt.isNumber(e)||this.exception("blackPlayerScore",et)}validateWhitePlayerFinish(e){tt.isBoolean(e)||this.exception("whitePlayerFinish",et)}validateBlackPlayerFinish(e){tt.isBoolean(e)||this.exception("blackPlayerFinish",et)}toObject(){return super.toObject()}static getDefaultData(){return Ko}};l(pi,"RespMatchDataDtos");let te=pi;te.addDefaultData(Ko);const fi=class fi extends Error{constructor(e){super(e),this.name="MatchAreNotFinished",this.message=e||"Match are not finished"}};l(fi,"MatchAreNotFinished");let js=fi;const gi=class gi extends Error{constructor(e){super(e),this.name="OpponentNotFinishedMatch",this.message=e||"Opponent not finished match"}};l(gi,"OpponentNotFinishedMatch");let Ks=gi;const wi=class wi extends A{async processAsync(e){super.processAsync(e),this.validateMatchData(e);const t=await this.getMatchAsync(e),s=new te(t).toObject();this.validateResultMatchData(e,s),this.updateMatchData(e,s),this.validatePlayerTurn(e),this.validateOpponentTurn(e),await this.nextAsync(e)}validateMatchData(e){const{id:t}=e;if(typeof t!="string")throw new Y}validateResultMatchData(e,t){const{id:s}=e,{_id:a,whitePlayerFinish:n,blackPlayerFinish:i}=t;if(typeof a!="string"||a!==s)throw new qt;if(!n&&!i)throw new js}validatePlayerTurn(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(typeof a!="string")throw new D;const{finished:n}=t[a];if(!n)throw new fe}validateOpponentTurn(e){const{profiles:t,customData:s}=e,{opponentId:a}=s;if(typeof a!="string")throw new M;const{finished:n}=t[a];if(!n)throw new Ks}async getMatchAsync(e){const{id:t}=e;return t?this.match.api.getMatchAPI().getMatchDetailByIdAsync(t):{}}updateMatchData(e,t){const{customData:s}=e,{whitePlayerId:a,blackPlayerId:n,whitePlayerScore:i,blackPlayerScore:o,whitePlayerFinish:r,blackPlayerFinish:c}=t,d=a===s.playerId,h=d?a:n,y=d?n:a;e.customData.playerId=h,e.customData.opponentId=y,e.profiles[h]||(e.profiles[h]={id:h,name:"",photo:"",finished:!0}),e.profiles[y]||(e.profiles[y]={id:y,name:"",photo:"",finished:!0});const g=d?i:o,w=d?o:i;e.profiles[h].score=g,e.profiles[y].score=w;const I=d?r:c,m=d?c:r;e.profiles[h].finished=I,e.profiles[y].finished=m}};l(wi,"ResultMatchHandler");let Ws=wi;const mi=class mi extends P{async processAsync(e){try{this.startLog(e);const{matchId:t,playerId:s,opponentId:a}=e,n=new v(this),i=new _(this,{id:t,mode:$.CHALLENGE_FRIEND,customData:{playerId:s,opponentId:a}});n.setNext(i);const o=new Ws(this);i.setNext(o);const r=new J(this);o.setNext(r);const c=new C(this);r.setNext(c);const d=this.match.getMatchState();await n.processAsync(d)}finally{this.endLog()}}};l(mi,"ResultChallengeMatchConcrete");let zs=mi;const Ai=class Ai extends P{constructor(){super(...arguments);u(this,"fallbackSingleMode");u(this,"startFLowChallengeFriend",l(async t=>{try{return await this.match.challenge.invite.processAsync(t),!0}catch(s){return s}},"startFLowChallengeFriend"));u(this,"startFlowTournament",l(async t=>{try{const s=GameSDK.context.getID();if(typeof s!="string")throw new K;await this.match.tournament.continue.processAsync({playerId:t,contextId:s})}catch{await this.startFlowSingle(t)}},"startFlowTournament"));u(this,"startFlowSingle",l(async t=>{if(!this.fallbackSingleMode){console.warn("Fallback single mode is not enabled");return}await this.match.single.start.processAsync({playerId:t})},"startFlowSingle"))}async processAsync(t){try{this.startLog(t);const{playerId:s,extraData:a,fallbackSingleMode:n}=t;this.fallbackSingleMode=n;const i=await this.startFLowChallengeFriend({playerId:s,extraData:a});if(i===!0)return;i instanceof Zt?await this.startFlowTournament(s):await this.startFlowSingle(s)}finally{this.endLog()}}};l(Ai,"ChooseContextConcrete");let Hs=Ai;const{Valid:Vc}=p.Utils,{Leaderboards:Fc}=p.Configs,Ii=class Ii extends bt{constructor(e){super(e,{score:0,leaderboardId:Fc.LeaderboardEndlessId})}async setupSetScorePayload(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(!a||!t[a])throw new B;const{endlessScore:n}=t[a];if(!Vc.isNumber(n))throw new St;this.payload.score=n,super.setupSetScorePayload(e)}};l(Ii,"PostGlobalLeaderboardEndlessScoreHandler");let qs=Ii;const Di=class Di extends A{async processAsync(e){super.processAsync(e),this.setPlayerEndlessScore(e),await this.nextAsync(e)}setPlayerEndlessScore(e){const{profiles:t,customData:s}=e,{playerId:a}=s;if(!a||!t[a])throw new B;const{player:n}=this.game,i=n.getBestEndlessScore()??0,{endlessScore:o=0}=t[a],r=i<o?o:i;n.setBestEndlessScore(r),t[a].bestEndlessScore=r}};l(Di,"SetPlayerEndlessScoreHandler");let Ys=Di;const Pi=class Pi extends P{async processAsync(){try{this.startLog();const e=new v(this),t=new At(this,{useAPI:!1});e.setNext(t);const s=new wt(this);t.setNext(s);const a=new Ys(this);s.setNext(a);const n=new qs(this);a.setNext(n);const i=new C(this);n.setNext(i);const o=this.match.getMatchState();await e.processAsync(o)}finally{this.endLog()}}};l(Pi,"FinishEndlessConcrete");let Qs=Pi;const Ei=class Ei extends Error{constructor(e){super(e),this.name="ProfileIdNotDefined",this.message=e??"Profile id is not defined"}};l(Ei,"ProfileIdNotDefined");let Xs=Ei;const{Dtos:Uc}=p,xi=class xi extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t);const{profileId:s}=this.payload;if(!s)throw new Xs;const{player:a}=this.game,n=a.getPlayerId();let i;if(s===n)i=this.getPlayerProfile();else if(i=await this.getProfileAsync(s),!i)throw new B;this.updateMatchData(i,t),await this.nextAsync(t)}getPlayerProfile(){const{player:t}=this.game,{playerId:s,name:a,photo:n,locale:i}=t.getPlayer();return{playerId:s,name:a,photo:n,locale:i}}async getProfileAsync(t){const{profile:s}=this.game;return await s.requestProfiles([t]),s.getProfiles()[t]}updateMatchData(t,s){const{playerId:a,name:n,photo:i}=t,o=new Uc.Match.Profile({id:a,name:n,photo:i}).toObject();s.profiles[a]=o}};l(xi,"GetProfileHandler");let It=xi;const vi=class vi extends P{async processAsync(e){try{this.startLog(e);const{playerId:t}=e,s=new v(this),a=new vt(this,{contextId:"SOLO"});s.setNext(a);const n=new _(this,{id:"234567",mode:$.ENDLESS,customData:{playerId:t}});a.setNext(n);const i=new W(this);n.setNext(i);const o=new It(this,{profileId:t});i.setNext(o);const r=new F(this);o.setNext(r);const c=new C(this);r.setNext(c);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};l(vi,"StartEndlessConcrete");let Js=vi;const{Valid:Bc}=p.Utils,Si=class Si extends bt{constructor(e){super(e,{score:0,leaderboardId:""})}async setupSetScorePayload(e){const{profiles:t,customData:s}=e,{playerId:a,leaderboardId:n}=s;if(!n)throw new mt;if(!a||!t[a])throw new B;const{score:i}=t[a];if(!Bc.isNumber(i))throw new St;this.payload.score=i,this.payload.leaderboardId=n,super.setupSetScorePayload(e)}};l(Si,"PostLeaderboardScoreHandler");let ee=Si;const bi=class bi extends A{async processAsync(e){super.processAsync(e),this.validateData(e),this.progressSendGroupMessage(e),await this.nextAsync(e)}validateData(e){const{id:t,customData:s}=e,{contextId:a,opponentId:n}=s;if(!t||typeof t!="string")throw new Y;if(!a||typeof a!="string")throw new K;if(!n||typeof n!="string")throw new M}async createWideframesResultGroupAsync(e){try{const{frameCapture:t}=this.game,{profiles:s,customData:a}=e,{playerId:n,opponentId:i}=a;if(!n||!i)return null;const o=s[n],r=s[i],{photo:c,score:d=0}=o,{photo:h,score:y=0}=r;return await t.wideframe.renderResultChallenge({playerId:n,playerPhoto:c,playerScore:d,opponentId:i,opponentPhoto:h,opponentScore:y,isPlayerFinished:!0,isOpponentFinished:!0})}catch(t){return console.warn("createWideframesResultGroupAsync",t),null}}async createWideframesBestScoreAsync(e){try{const{player:t,frameCapture:s}=this.game,{playerId:a}=e.customData,{playerId:n,photo:i,data:o}=t.getPlayer();if(a!==n)return null;const{score:r}=o||{};return await s.wideframe.renderShareScore({playerId:n,playerPhoto:i,playerScore:r})}catch(t){return console.warn("createWideframesBestScoreAsync",t),null}}async progressSendGroupMessage(e){const{profiles:t,customData:s}=e,{playerId:a,opponentId:n}=s;if(n&&typeof n=="string"){if(!a||typeof a!="string")throw new D;const{score:o=0}=t[a]||{},{score:r=0}=t[n]||{};if(o>r){const c=await this.createWideframesResultGroupAsync(e);if(!c)return;this.sendBestScoreMessageAsync(e,c);return}}const i=await this.createWideframesBestScoreAsync(e);i&&this.sendChallengeMessageAsync(e,i)}async sendBestScoreMessageAsync(e,t){const{profiles:s,customData:a}=e,{playerId:n}=a;if(!n||typeof n!="string")throw new D;if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");const{name:i,score:o}=s[n],c={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:i,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chi"}},text:{default:`${i} beats your high score. Their score: ${o}.`,localizations:{vi_VN:`${i} va vt im s cao nht ca bn! Chi ln na ch?`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(c)}async sendChallengeMessageAsync(e,t){const{profiles:s,customData:a}=e,{playerId:n}=a;if(!n||typeof n!="string")throw new D;const{name:i,score:o}=s[n],c={data:{type:this.game.context.getSessionContextTypes().MATCHING_GROUP,playerId:n,playerName:i,playerScore:o},action:"CUSTOM",template:"play_turn",cta:{default:"Play",localizations:{vi_VN:"Chi ngay"}},text:{default:`${i} got ${o} scores. So easy! Can you?`,localizations:{vi_VN:`${i}  t ${o} im! Qu d lun. Chi li no!`}},image:t,strategy:"IMMEDIATE",notification:"PUSH"};if(!("updateAsync"in GameSDK.extra))throw new E("updateAsync");await GameSDK.extra.updateAsync(c)}};l(bi,"SendGroupMessageHandler");let Zs=bi;const Ni=class Ni extends P{async processAsync(){try{this.startLog();const e=new v(this),t=new At(this,{useAPI:!1});e.setNext(t);const s=new Zs(this);t.setNext(s);const a=new wt(this);s.setNext(a);const n=new Nt(this);a.setNext(n);const i=new ee(this);n.setNext(i);const o=new C(this);i.setNext(o);const r=this.match.getMatchState();await e.processAsync(r)}finally{this.endLog()}}};l(Ni,"FinishGroupConcrete");let ta=Ni;const{Dtos:jc}=p,Ci=class Ci extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.updateProfileMatchData(t),await this.nextAsync(t)}updateProfileMatchData(t){const{id:s}=this.payload,{profiles:a}=t;if(!a[s])throw new B;const n={...a[s],...this.payload},i=new jc.Match.Profile(n).toObject();a[i.id]=i}};l(Ci,"SetProfileDataHandler");let Ct=Ci;const Li=class Li extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,opponentId:s,opponentScore:a}=e,n=new v(this),i=new _(this,{id:"7749",mode:$.MATCHING_GROUP,customData:{playerId:t,opponentId:s}});n.setNext(i);const o=new J(this);i.setNext(o);const r=new Ct(this,{id:t,score:a});o.setNext(r);const c=new W(this);r.setNext(c);const d=new F(this);c.setNext(d);const h=new C(this);d.setNext(h);const y=this.match.getMatchState();await n.processAsync(y)}finally{this.endLog()}}};l(Li,"JoinGroupConcrete");let ea=Li;const Ti=class Ti extends Error{constructor(e){super(e),this.name="MatchGroupNotSupported",this.message=e??"Match group is not supported"}};l(Ti,"MatchGroupNotSupported");let Ie=Ti;const Oi=class Oi extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),await this.checkMatchGroupSupported();const s=await this.matchingGroup();t.customData.contextId=s,await this.nextAsync(t)}async checkMatchGroupSupported(){if(!("getSupportedAPIs"in GameSDK))throw new E("getSupportedAPIs");if(!("checkCanPlayerMatchAsync"in GameSDK.extra))throw new E("checkCanPlayerMatchAsync");if(!(GameSDK.getSupportedAPIs().indexOf("checkCanPlayerMatchAsync")>-1))throw new Ie;if(!await GameSDK.extra.checkCanPlayerMatchAsync())throw new Ie}async matchingGroup(){if(!("matchPlayerAsync"in GameSDK.extra))throw new E("matchPlayerAsync");const{matchTag:t,autoSwitch:s=!1,onlyExisting:a=!1}=this.payload;await GameSDK.extra.matchPlayerAsync(t,s,a);const n=GameSDK.context.getID();if(typeof n!="string")throw new Qt;return n}};l(Oi,"GroupContextHandler");let sa=Oi;const Ri=class Ri extends P{async processAsync(e){try{this.startLog(e);const{matchTag:t,playerId:s,options:a}=e,n=new v(this),i=new sa(this,{matchTag:t,...a});n.setNext(i);const o=new _(this,{id:"7749",mode:$.MATCHING_GROUP,customData:{playerId:s}});i.setNext(o);const r=new Ae(this,{ignoreId:s});o.setNext(r);const c=new W(this);r.setNext(c);const d=new J(this);c.setNext(d);const h=new F(this);d.setNext(h);const y=new C(this);h.setNext(y);const g=this.match.getMatchState();await n.processAsync(g)}finally{this.endLog()}}};l(Ri,"StartGroupConcrete");let aa=Ri;const Mi=class Mi extends P{async processAsync(){try{this.startLog();const e=new v(this),t=new At(this,{useAPI:!1});e.setNext(t);const s=new wt(this);t.setNext(s);const a=new Nt(this);s.setNext(a);const n=new Jt(this);a.setNext(n);const i=new C(this);n.setNext(i);const o=this.match.getMatchState();await e.processAsync(o)}finally{this.endLog()}}};l(Mi,"FinishSingleConcrete");let na=Mi;const _i=class _i extends P{async processAsync(e){try{this.startLog(e);const{playerId:t}=e,s=new v(this),a=new vt(this,{contextId:"SOLO"});s.setNext(a);const n=new _(this,{id:"123456",mode:$.SINGLE,customData:{playerId:t}});a.setNext(n);const i=new W(this);n.setNext(i);const o=new It(this,{profileId:t});i.setNext(o);const r=new F(this);o.setNext(r);const c=new C(this);r.setNext(c);const d=this.match.getMatchState();await s.processAsync(d)}finally{this.endLog()}}};l(_i,"StartSingleConcrete");let ia=_i;const{Plugins:Kc,Utils:Wc}=p,{Analytics:zc}=Kc,{String:Hc,Valid:qc}=Wc,$i=class $i extends A{async processAsync(e){super.processAsync(e);const{mode:t,customData:s}=e;this.validateMode(t);const{analytics:a}=this.game,{tournamentId:n,leaderboardId:i}=s;a.event(zc.Events.TOURNAMENT_START,{success:!0,game_mode:Hc.toUpperCamelCase(t),tournament_id:n,leaderboard_id:i}),await this.nextAsync(e)}validateMode(e){if(!qc.isString(e))throw new Ht}};l($i,"LogTournamentStartHandler");let De=$i;const Gi=class Gi extends Error{constructor(e){super(e),this.name="TournamentIdNotValid",this.message=e??"Tournament id is not valid"}};l(Gi,"TournamentIdNotValid");let Pe=Gi;const{Valid:oa}=p.Utils,ki=class ki extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t);const{contextId:s}=this.payload;this.validateContextId(s);const a=await GameSDK.getTournamentAsync(),n=a.getID().toString();this.validateTournamentId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:o}=i;this.validateLeaderboardId(o),t.customData.contextId=s,t.customData.tournamentId=n,t.customData.leaderboardId=o,await this.nextAsync(t)}validateContextId(t){if(!oa.isString(t))throw new K}validateTournamentId(t){if(!oa.isString(t))throw new Pe}validateLeaderboardId(t){if(!oa.isString(t)||t==="")throw new mt}};l(ki,"ContinueTournamentHandler");let ra=ki;const Vi=class Vi extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,contextId:s}=e,a=new v(this),n=new ra(this,{contextId:s});a.setNext(n);const i=new _(this,{id:"1997",mode:$.TOURNAMENT,customData:{playerId:t}});n.setNext(i);const o=new W(this);i.setNext(o);const r=new It(this,{profileId:t});o.setNext(r);const c=new F(this);r.setNext(c);const d=new De(this);c.setNext(d);const h=new C(this);c.setNext(h);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}};l(Vi,"ContinueTournamentConcrete");let ca=Vi;const{Plugins:Yc}=p,{Analytics:Qc}=Yc,Fi=class Fi extends A{async processAsync(e){super.processAsync(e);const{customData:t}=e,{analytics:s}=this.game,{tournamentId:a,leaderboardId:n}=t;s.event(Qc.Events.TOURNAMENT_CREATE,{success:!0,tournament_id:a,leaderboard_id:n}),await this.nextAsync(e)}};l(Fi,"LogTournamentCreateHandler");let la=Fi;const Ui=class Ui extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),await this.createTournamentAsync(),await this.updateMatchStateAsync(t),await this.nextAsync(t)}async createTournamentAsync(){const{name:t,score:s,customData:a}=this.payload;await GameSDK.tournament.createAsync({initialScore:s,config:{title:t,tournamentTitle:t},data:a})}async updateMatchStateAsync(t){try{if(!("getTournamentAsync"in GameSDK))throw new E("getTournamentAsync");const s=await GameSDK.getTournamentAsync(),a=s.getContextID(),n=s.getID().toString(),{playerId:i}=this.payload;t.customData.playerId=i,t.customData.contextId=a,t.customData.tournamentId=n}catch(s){if(s instanceof E)return}}};l(Ui,"CreateTournamentHandler");let da=Ui;const{Valid:Wo}=p.Utils,Bi=class Bi extends A{constructor(t,s){super(t);u(this,"payload");u(this,"leaderboardPayload");this.payload=s}async processAsync(t){super.processAsync(t),this.validatePayload(),await this.setupCreatePayload(t),await this.createLeaderboardAsync(t),await this.nextAsync(t)}validatePayload(){const{leaderboardId:t}=this.payload;if(!Wo.isString(t))throw new mt}validatePlayerId(t){if(!Wo.isString(t))throw new D}async setupCreatePayload(t){const{playerId:s}=t.customData;this.validatePlayerId(s);const{name:a,leaderboardId:n,customData:i}=this.payload;this.leaderboardPayload={_id:n,name:a??"",createdBy:s,description:JSON.stringify(i)}}async createLeaderboardAsync(t){const s=await this.game.leaderboard.createLeaderboardAsync(this.leaderboardPayload);t.customData.leaderboardId=s}};l(Bi,"CreateLeaderboardHandler");let ha=Bi;const ji=class ji extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,name:s,score:a,leaderboardId:n,payload:i}=e,o=new v(this),r=new vt(this,{contextId:"SOLO"});o.setNext(r);const c=new da(this,{name:s,score:a,playerId:t,customData:i});r.setNext(c);const d=new It(this,{profileId:t});c.setNext(d);const h=new Ct(this,{id:t,score:a});d.setNext(h);const y=new ha(this,{name:s,customData:i,leaderboardId:n});h.setNext(y);const g=new ee(this);y.setNext(g);const w=new la(this);g.setNext(w);const I=this.match.getMatchState();await o.processAsync(I)}finally{this.endLog()}}};l(ji,"CreateTournamentConcrete");let ua=ji;const{Analytics:zo}=p.Plugins,{Valid:Xc}=p.Utils,Ki=class Ki extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.validateData(t),await this.postScoreTournamentAsync(t),await this.nextAsync(t)}validateData(t){const{profiles:s,customData:a}=t,{playerId:n}=a;if(this.validatePlayerId(n),!s[n])throw new B}validatePlayerId(t){if(!Xc.isString(t))throw new D}getPlayerProfile(t){const{profiles:s,customData:a}=t,{playerId:n}=a;return this.validatePlayerId(n),s[n]}isNewBestScore(t){const s=this.getPlayerProfile(t),{score:a=0,bestScore:n=0}=s;return a>n}async postScoreTournamentAsync(t){const{analytics:s}=window.game,a=this.getPlayerProfile(t),{score:n=0}=a;let i=null,o=!1;const{checkBestScore:r}=this.payload,c=this.isNewBestScore(t);try{if(!("getTournamentAsync"in GameSDK))throw new E("getTournamentAsync");await GameSDK.getTournamentAsync(),!r||c?(i=zo.Events.TOURNAMENT_SHARE,await GameSDK.tournament.shareAsync({score:n})):(i=zo.Events.TOURNAMENT_POST_SCORE,await GameSDK.tournament.postScoreAsync(n)),o=!0}catch(d){console.warn("Post Score Tournament",d)}finally{i&&s.event(i,{success:o})}}};l(Ki,"PostScoreTournamentHandler");let ya=Ki;const Wi=class Wi extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,bestScore:s}=e,a=new v(this),n=new At(this,{useAPI:!1});a.setNext(n);const i=new Ct(this,{id:t,bestScore:s});n.setNext(i);const o=new ya(this,{checkBestScore:!1});i.setNext(o);const r=new wt(this);o.setNext(r);const c=new Nt(this);r.setNext(c);const d=new ee(this);c.setNext(d);const h=new Jt(this);d.setNext(h);const y=new C(this);h.setNext(y);const g=this.match.getMatchState();await a.processAsync(g)}finally{this.endLog()}}};l(Wi,"FinishTournamentConcrete");let pa=Wi;const{Valid:fa,Object:Jc}=p.Utils,zi=class zi extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t);const{tournamentId:s}=this.payload;this.validateTournamentId(s),await this.joinTournamentAsync(s);const a=await GameSDK.getTournamentAsync(),n=a.getContextID();this.validateContextId(n);const i=JSON.parse(a.getPayload()||"{}"),{leaderboardId:o}=i;this.validateLeaderboardId(o),t.customData.contextId=n,t.customData.tournamentId=s,t.customData.leaderboardId=o,await this.nextAsync(t)}validateTournamentId(t){if(!fa.isString(t))throw new Pe}validateContextId(t){if(!fa.isString(t))throw new K}validateLeaderboardId(t){if(!fa.isString(t)||t==="")throw new mt}async joinTournamentAsync(t){if(!("tournament"in GameSDK))throw new E("tournament");try{await GameSDK.tournament.joinAsync(t)}catch(s){if(!Jc.hasOwn(s,"code")||s.code!=="SAME_CONTEXT")throw s}}};l(zi,"JoinTournamentHandler");let ga=zi;const Hi=class Hi extends P{async processAsync(e){try{this.startLog(e);const{playerId:t,tournamentId:s}=e,a=new v(this),n=new ga(this,{tournamentId:s});a.setNext(n);const i=new _(this,{id:"1997",mode:$.TOURNAMENT,customData:{playerId:t}});n.setNext(i);const o=new W(this);i.setNext(o);const r=new It(this,{profileId:t});o.setNext(r);const c=new F(this);r.setNext(c);const d=new De(this);c.setNext(d);const h=new C(this);d.setNext(h);const y=this.match.getMatchState();await a.processAsync(y)}finally{this.endLog()}}};l(Hi,"JoinTournamentConcrete");let wa=Hi;const{Dtos:Zc,Utils:tl}=p,{Object:el}=tl,qi=class qi extends A{constructor(t,s){super(t);u(this,"payload");this.payload=s}async processAsync(t){super.processAsync(t),this.updateMatchCustomData(t),await this.nextAsync(t)}updateMatchCustomData(t){const s=el.merge(t.customData,this.payload),a=new Zc.Match.CustomData(s).toObject();t.customData=a}};l(qi,"SetMatchCustomDataHandler");let ma=qi;const sl={id:null,mode:null,status:null,startAt:0,finishAt:0,profiles:{},customData:{...Ds}},{Configs:Ho}=p,Yi=class Yi extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"base");u(this,"group");u(this,"single");u(this,"endless");u(this,"context");u(this,"challenge");u(this,"tournament");u(this,"api");u(this,"handler");u(this,"useCPUProfile")}init(){this.createMatchData(),this.createAPIHandler(),this.createBaseConcrete(),this.createConcreteFlows(),this.createConcreteHandlers()}setUseCPUProfile(t){this.useCPUProfile=t}createMatchData(){const{storage:t}=this.game;t.addStorage("match",sl)}getMatchState(){const{storage:t}=this.game;return t.getStorage("match")}createBaseConcrete(){this.base=new P(this.game,this)}createConcreteFlows(){this.createGroupFlows(),this.createSingleFlows(),this.createEndlessFlows(),this.createContextFlows(),this.createChallengeFlows(),this.createTournamentFlows()}createConcreteHandlers(){this.handler={setProfileData:l(async t=>{const s=new Ct(this.base,t);await this.processHandlerAsync(s)},"setProfileData"),setMatchCustomData:l(async t=>{const s=new ma(this.base,t);await this.processHandlerAsync(s)},"setMatchCustomData"),setLeaderboardScore:l(async t=>{const s=new bt(this.base,t);await this.processHandlerAsync(s)},"setLeaderboardScore")}}createAPIHandler(){const t={appId:Ho.AppId,matchAPIHost:Ho.ApiHost};this.api=new ws(t)}createGroupFlows(){this.group={join:new ea(this.game,this),start:new aa(this.game,this),finish:new ta(this.game,this)}}createSingleFlows(){this.single={start:new ia(this.game,this),finish:new na(this.game,this)}}createEndlessFlows(){this.endless={start:new Js(this.game,this),finish:new Qs(this.game,this)}}createContextFlows(){this.context={choose:new Hs(this.game,this)}}createChallengeFlows(){this.challenge={invite:new $s(this.game,this),friend:new vs(this.game,this),join:new Bs(this.game,this),await:new Es(this.game,this),result:new zs(this.game,this),finish:new Ts(this.game,this),continue:new Ns(this.game,this)}}createTournamentFlows(){this.tournament={join:new wa(this.game,this),create:new ua(this.game,this),finish:new pa(this.game,this),continue:new ca(this.game,this)}}processHandlerAsync(t){const s=this.getMatchState();return t.processAsync(s)}};l(Yi,"MatchPlugin");let Aa=Yi;const{Valid:Dt}=p.Utils,Pt="is invalid",Qi=class Qi extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateLevel(e){(!Dt.isNumber(e)||e<0)&&this.exception("level",Pt)}validateRescued(e){(!Dt.isNumber(e)||e<0)&&this.exception("rescued",Pt)}validateContextId(e){Dt.isString(e)||this.exception("contextId",Pt)}validatePlayerId(e){Dt.isString(e)||this.exception("playerId",Pt)}validateOpponentId(e){Dt.isString(e)||this.exception("opponentId",Pt)}validateTournamentId(e){Dt.isString(e)||this.exception("tournamentId",Pt)}validateLeaderboardId(e){Dt.isString(e)||this.exception("leaderboardId",Pt)}toObject(){return super.toObject()}static getDefaultData(){return G.getDefaultData()}};l(Qi,"MatchCustomDataDtos");let Ee=Qi;Ee.addDefaultData(Ds);const{Valid:ct}=p.Utils,lt="is invalid",Xi=class Xi extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateId(e){(!ct.isString(e)||!e)&&this.exception("id",lt)}validateName(e){(!ct.isString(e)||!e)&&this.exception("name",lt)}validatePhoto(e){ct.isString(e)||this.exception("photo",lt)}validateScore(e){(!ct.isNumber(e)||e<0)&&this.exception("score",lt)}validateBestScore(e){(!ct.isNumber(e)||e<0)&&this.exception("bestScore",lt)}validateEndlessScore(e){(!ct.isNumber(e)||e<0)&&this.exception("endlessScore",lt)}validateBestEndlessScore(e){(!ct.isNumber(e)||e<0)&&this.exception("bestEndlessScore",lt)}validateFinished(e){ct.isBoolean(e)||this.exception("finished",lt)}toObject(){return super.toObject()}static getDefaultData(){return G.getDefaultData()}};l(Xi,"MatchProfileDtos");let xe=Xi;xe.addDefaultData({id:"",name:"Your Friend",photo:"./assets/images/others/avatar.png",score:0,bestScore:0,finished:!1,endlessScore:0,bestEndlessScore:0}),p.Dtos.Match={Data:te,CustomData:Ee,Profile:xe};const{Utils:al}=p,{ApiHost:nl}=p.Configs,il=l(async f=>{let e="players";GameSDK.getSDKName()==="MsGames"&&(e="players?platform=ms-games");const t=await k(e,f,{},nl,10);return al.Object.hasOwn(t,"data")?t.data||{}:{}},"updatePlayerProfileAsync"),{Utils:ol,Configs:rl}=p,{AppId:cl}=rl,{Array:ll,Object:ve,Valid:dl}=ol,Ji=class Ji extends T.Plugins.BasePlugin{init(){const{storage:e}=this.game;e.addStorage("player",ht)}async saveToCloud(){try{const e=this.getPlayerData();await GameSDK.player.setDataAsync(e)}catch(e){console.warn(e)}}receiveData(e,t){const{storage:s}=this.game,{playerId:a,name:n,photo:i,locale:o}=e;s.setStorageData("player","playerId",a),s.setStorageData("player","name",n),s.setStorageData("player","photo",i),s.setStorageData("player","locale",o),t&&this.setPlayerData(t)}async syncProfileToServer(){const{storage:e}=this.game,t=this.getPlayer(),{playerId:s,name:a,photo:n,locale:i}=t;let o=this.getPlayerASID();!dl.isString(o)&&"getASIDAsync"in GameSDK.player&&(o=await GameSDK.player.getASIDAsync()??o,e.setStorageData("player","ASID",`${o}`)),await il({appId:cl,ASID:o,playerId:s,name:a,photo:n,locale:i})}setPlayerDataByName(e,t){this.setPlayerData({[e]:t})}setPlayerData(e){const{storage:t}=this.game;t.setStorageData("player","data",e),this.saveToCloud()}setBestScore(e){this.setPlayerDataByName("score",e)}setBestEndlessScore(e){this.setPlayerDataByName("endlessScore",e)}setSetting(e,t){this.setPlayerDataByName("settings",{[e]:t})}setGameData(e){const t=this.getGameData()??{},s=ve.merge(t,e);this.setPlayerDataByName("gameData",s)}async requestConnectedPlayers(){const{storage:e}=this.game,s=(await GameSDK.player.getConnectedPlayersAsync()).map(i=>{const o=i.getID(),r=i.getName(),c=i.getPhoto();return!o||!r||!c?null:new Et({playerId:o,name:r,photo:c}).toObject()}),a=ll.unique(s);if(a.length<1)return;const n=ve.keyBy(a,"playerId");e.setStorageData("player","connectedPlayers",n)}getPlayer(){const{storage:e}=this.game;return e.getStorage("player")}getPlayerId(){const{storage:e}=this.game;return e.getStorageData("player","playerId")}getPlayerASID(){const{storage:e}=this.game;return e.getStorageData("player","ASID")}getPlayerLocale(){const{storage:e}=this.game;return e.getStorageData("player","locale")}getPlayerData(){const{storage:e}=this.game;return e.getStorageData("player","data")}getPlayerDataByKey(e){const t=this.getPlayerData();return ve.hasOwn(t,e)?t[e]:null}getGameData(){return this.getPlayerDataByKey("gameData")}getPlayerSetting(e){const t=this.getPlayerSettings();return ve.hasOwn(t,e)?t[e]:null}getPlayerSettings(){const{settings:e}=this.getPlayerData();return e}isFirstLogin(){return this.getPlayerDataByKey("isFirstLogin")??ht.data.isFirstLogin}loggedIn(){this.setPlayerDataByName("isFirstLogin",!1)}getBestScore(){const{score:e}=this.getPlayerData();return e}getBestEndlessScore(){const{endlessScore:e}=this.getPlayerData();return e}getConnectedPlayers(){const{storage:e}=this.game;return e.getStorageData("player","connectedPlayers")}getConnectedPlayerIds(e,t){const s=this.getConnectedPlayers();return Object.keys(s).slice(t,t+e)}getNotificationData(){return this.getPlayerDataByKey("notificationData")??ht.data.notificationData}};l(Ji,"PlayerPlugin");let Ia=Ji;const{Dtos:qo,Utils:hl}=p,{Valid:st}=hl,{score:Yo,endlessScore:ul,settings:yl,gameData:pl,isFirstLogin:fl,dailyRewarded:gl,notificationData:wl}=ht.data,at="is invalid",Zi=class Zi extends G{processData(e){this.validateStructure(e),e.settings=new qo.Player.Settings(e.settings).toObject(),e.gameData=new qo.Player.GameData(e.gameData).toObject(),this.validateData(e),this.setupData(e)}setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateScore(e){(!st.isNumber(e)||e<0)&&this.exception("score",at)}validateEndlessScore(e){(!st.isNumber(e)||Yo<0)&&this.exception("endlessScore",at)}validateSettings(e){st.isObject(e)||this.exception("settings",at)}validateNotificationData(e){st.isObject(e)||this.exception("notificationData",at),(!("lastSent"in e)||!st.isNumber(e.lastSent))&&this.exception("notificationData.lastSent",at),(!("currentId"in e)||!st.isNumber(e.currentId))&&this.exception("notificationData.currentId",at)}validateGameData(e){st.isObject(e)||this.exception("gameData",at)}validateIsFirstLogin(e){st.isBoolean(e)||this.exception("isFirstLogin",at)}validateDailyRewarded(e){st.isObject(e)||this.exception("dailyRewarded",at)}toObject(){return super.toObject()}};l(Zi,"PlayerDataDtos");let Se=Zi;Se.addDefaultData({score:Yo,endlessScore:ul,settings:yl,gameData:pl,isFirstLogin:fl,dailyRewarded:gl,notificationData:wl});const{Valid:Qo}=p.Utils,{level:ml,coins:Al}=ht.data.gameData,to=class to extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateLevel(e){(!Qo.isNumber(e)||e<0)&&this.exception("level","is invalid")}validateCoins(e){(!Qo.isNumber(e)||e<0)&&this.exception("coins","is invalid")}toObject(){return super.toObject()}};l(to,"PlayerGameDataDtos");let be=to;be.addDefaultData({level:ml,coins:Al});const{Valid:Ne}=p.Utils,{sound:Il,music:Dl,vibrate:Pl,language:El}=ht.data.settings,Ce="is invalid",eo=class eo extends G{setupData(e){this.lazySetupData(e)}validateStructure(e){this.lazyValidateStructure(e)}validateData(e){this.lazyValidateData(e)}validateSound(e){Ne.isBoolean(e)||this.exception("sound",Ce)}validateMusic(e){Ne.isBoolean(e)||this.exception("music",Ce)}validateVibrate(e){Ne.isBoolean(e)||this.exception("vibrate",Ce)}validateLanguage(e){(!Ne.isString(e)||!e)&&this.exception("language",Ce)}toObject(){return super.toObject()}};l(eo,"PlayerSettingsDtos");let Le=eo;Le.addDefaultData({sound:Il,music:Dl,vibrate:Pl,language:El}),p.Dtos.Player={Info:Et,Data:Se,Settings:Le,GameData:be};const{Configs:xl,Utils:vl}=p,{Object:Sl,String:bl}=vl,{ApiHost:Nl,Mockup:Cl}=xl,so=class so{constructor(){u(this,"mockAPI")}async initMockAPI(){if(this.mockAPI)return;const e=(await it(async()=>{const{default:t}=await Promise.resolve().then(()=>Ut);return{default:t}},void 0,N.meta.url)).default;if(typeof e!="function")throw new Error("Cannot load ProfileAPIMock");this.mockAPI=new e}async getPlayersAsync(e){const t=bl.params(e);let s;return Cl.Profile.Enabled?(await this.initMockAPI(),s=await this.mockAPI.getPlayersAsync(e)):s=await ut(`players?${t}`,{},Nl),!Sl.hasOwn(s,"data")||!Array.isArray(s.data)?[]:s.data}};l(so,"ProfileAPI");let Da=so;const Ll={profiles:{},profileIds:[]},{Utils:Tl,Dtos:Ol}=p,{Array:Xo,Valid:Rl,Object:Ml,Function:_l}=Tl,ao=class ao extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"profileAPI",new Da)}init(){const{storage:t}=this.game;t.addStorage("profile",Ll)}async requestProfiles(t){const s=this.getProfileIds(),a=Xo.difference(t,s);if(a.length<1)return;const i=Xo.chunk(a,400).map(d=>this.profileAPI.getPlayersAsync({playerIds:d})),r=(await _l.allSettled(i)).reduce((d,h)=>h.status==="fulfilled"?d.concat(h.value):d,[]);if(!this.validateProfilesResponse(r))return;const c=this.convertToProfiles(r);this.setProfiles(c)}getProfile(t){return this.getProfiles()[t]??null}getProfiles(){const{storage:t}=this.game;return t.getStorageData("profile","profiles")}setProfiles(t){const{storage:s}=this.game;s.setStorageData("profile","profiles",t),s.setStorageData("profile","profileIds",Object.keys(t))}getProfileIds(){const{storage:t}=this.game;return t.getStorageData("profile","profileIds")}validateProfilesResponse(t){return!(!Array.isArray(t)||t.length<1)}convertToProfiles(t){const s={};for(const a of t)Ml.hasOwn(a,"playerId")&&Rl.isString(a.playerId)&&(s[a.playerId]=new Ol.Player.Info(a).toObject());return s}};l(ao,"ProfilePlugin");let Pa=ao;const Jo="Tile Connect Remaster",{Utils:{Object:Zo,Valid:tr,Browser:er}}=p,no=class no extends T.Plugins.BasePlugin{constructor(t){super(t);u(this,"storages");u(this,"storageLocalKeys",{});this.storages={}}async addStorage(t,s,a=!1){console.info("addStorage",t,s),this.storages[t]=s,a&&await this.initFromWebStorage(t,s)}async initFromWebStorage(t,s){this.storageLocalKeys[t]=!0;const a=await er.getIndexedDB(`${Jo}_S_${t}`);if(!tr.isObject(a))return;const n=Object.keys(s);for(const i of n)Zo.hasOwn(a,i)&&typeof s[i]==typeof a[i]&&this.setStorageData(t,i,a[i])}setStorageData(t,s,a){let n;if(tr.isObject(a)){const i=this.getStorageData(t,s);n=Zo.merge(i,a)}else n=a;this.storages[t][s]=n}getStorageData(t,s){return this.getStorage(t)[s]}getStorage(t){return this.storages[t]}updateToWebStorage(t){this.storageLocalKeys[t]&&this.saveToWebStorage(t)}saveToWebStorage(t){const s=this.getStorage(t);er.setIndexedDB(`${Jo}_S_${t}`,s)}};l(no,"StoragePlugin");let Ea=no;const io=class io extends T.Plugins.BasePlugin{constructor(){super(...arguments);u(this,"isVisible",!0);u(this,"browserPrefixes",["moz","ms","o","","webkit"]);u(this,"handleVisibilityChange",l(t=>{if(["focus","blur"].indexOf(t)>-1)return t==="focus"?this.onVisibleEvent():this.onHiddenEvent();const a=this.getBrowserPrefix();return this.getHiddenPropertyName(a)in document?this.onHiddenEvent():this.onVisibleEvent()},"handleVisibilityChange"))}init(){const t=this.getBrowserPrefix(),a=[this.getVisibilityEvent(t),"focus","blur"];for(const n of a)window.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1),document.addEventListener(n,()=>{this.handleVisibilityChange(n)},!1);GameSDK.extra&&"onPause"in GameSDK.extra&&GameSDK.extra.onPause(()=>{this.handleVisibilityChange("blur")})}isGameVisible(){return this.isVisible}getHiddenPropertyName(t){return t?`${t}Hidden`:"hidden"}getVisibilityEvent(t){return`${t||""}visibilitychange`}getBrowserPrefix(){for(const t of this.browserPrefixes)if(this.getHiddenPropertyName(t)in document)return t;return""}onVisibleEvent(){this.isVisible||(this.isVisible=!0,this.game.event.emit(p.Events.VISIBILITY_VISIBLE))}onHiddenEvent(){this.isVisible&&(this.isVisible=!1,this.game.event.emit(p.Events.VISIBILITY_HIDDEN))}};l(io,"VisibilityPlugin");let xa=io;const oo=class oo extends vo{async loadAsync(){this.exception("Unsupported method")}async showAsync(){this.exception("This method is not implemented")}async hideAsync(){this.exception("This method is not implemented")}};l(oo,"BannerInstance");let va=oo;const{Status:sr}=p.Plugins.Ads,ro=class ro extends va{async showAsync(){await GameSDK.loadBannerAdAsync(this.placementId),this.setStatus(sr.SHOWING)}async hideAsync(){await GameSDK.hideBannerAdAsync(this.placementId),this.setStatus(sr.IDLE)}};l(ro,"BannerAdInstance");let Sa=ro;const{Object:$l}=p.Utils,{Status:z,Types:R,AdError:Te,AdInstance:Gl}=p.Plugins.Ads,co=class co extends Gl{constructor(t,s){super(t,s);u(this,"instance");u(this,"interstitialAdInstanceList",[]);u(this,"rewardedVideoAdInstanceList",[]);u(this,"rewardedInterstitialAdInstanceList",[]);this.instance=null}async loadAsync(){if(console.info("AdInstance","loadAsync called",{type:this.type,status:this.status}),!(this.instance&&this.status===z.FILLED)){if(this.status!==z.IDLE)throw new Te("AD_NOT_READY","Ad is not ready.");try{if(this.instance=await this.createInstanceByType(this.type),this.instance===null)throw new Te("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");this.setStatus(z.LOADING),await this.instance.loadAsync(),this.setStatus(z.FILLED),console.info("AdInstance","loadAsync success",{type:this.type,status:this.status}),this.logAdLoad()}catch(t){throw console.warn("AdInstance","loadAsync failed",{type:this.type,status:this.status,error:t}),this.setStatus(z.IDLE),t instanceof Object&&"code"in t&&t.code==="INVALID_PARAM"&&(this.instance=null),this.instance&&this.pushInstanceToQueue(this.instance),self.game.analytics.loadAdFail(this.type),t}}}async showAsync(){if(console.info("AdInstance","showAsync called",{type:this.type,status:this.status}),this.status!==z.FILLED)throw new Te("AD_NOT_FILLED","Ad is not filled.");if(this.instance===null)throw new Te("AD_INSTANCE_NOT_INITIATED","Ad instance didn't initiated.");let t=!1;try{this.setStatus(z.SHOWING),self.game.analytics.showingAd(this.type),await this.instance.showAsync(),t=!0,this.setStatus(z.IDLE),this.instance=null,console.info("AdInstance","showAsync success",{type:this.type,status:this.status})}catch(s){throw console.warn("AdInstance","showAsync failed",{type:this.type,status:this.status,error:s}),p.Utils.Object.hasOwn(s,"code")&&(s.code==="AD_NOT_LOADED"&&this.setStatus(z.IDLE),["INVALID_PARAM","INVALID_OPERATION","USER_INPUT"].indexOf(`${s.code}`)>-1&&(this.setStatus(z.IDLE),this.instance=null),s.code==="USER_INPUT"&&(t=!0)),this.status===z.SHOWING&&(this.setStatus(z.IDLE),this.instance=null),s}finally{t?this.logAdShown():self.game.analytics.showAdFail(this.type)}}async createInstanceByType(t){try{return await this.getAdInstanceByType(t)}catch(s){return $l.hasOwn(s,"code")&&s.code==="ADS_TOO_MANY_INSTANCES"?this.getAdInstanceFailed(t):null}}async getAdInstanceByType(t){switch(t){case R.REWARDED_VIDEO:return await GameSDK.getRewardedVideoAsync(this.placementId);case R.INTERSTITIAL:return await GameSDK.getInterstitialAdAsync(this.placementId);case R.REWARDED_INTERSTITIAL:return await GameSDK.getRewardedInterstitialAsync(this.placementId);default:return null}}getAdInstanceFailed(t){let s=null;switch(t){case R.INTERSTITIAL:s=this.interstitialAdInstanceList;break;case R.REWARDED_VIDEO:s=this.rewardedVideoAdInstanceList;break;case R.REWARDED_INTERSTITIAL:s=this.rewardedInterstitialAdInstanceList;break}if(s===null)return null;if("canBeLoadedAd"in GameSDK.extra){for(const a of s)if(GameSDK.extra.canBeLoadedAd(a))return s.splice(s.indexOf(a),1),a}else return s.shift()||null;return null}logAdLoad(){switch(this.type){case R.INTERSTITIAL:self.game.analytics.loadInterstitialAd();break;case R.REWARDED_VIDEO:self.game.analytics.loadRewardedVideoAd();break;case R.REWARDED_INTERSTITIAL:self.game.analytics.loadRewardedInterstitialAd();break}}logAdShown(){switch(this.type){case R.INTERSTITIAL:self.game.analytics.showInterstitialAd();break;case R.REWARDED_VIDEO:self.game.analytics.showRewardedVideoAd();break;case R.REWARDED_INTERSTITIAL:self.game.analytics.showRewardedInterstitialAd();break}}pushInstanceToQueue(t){let s=null;switch(this.type){case R.INTERSTITIAL:s=this.interstitialAdInstanceList;break;case R.REWARDED_VIDEO:s=this.rewardedVideoAdInstanceList;break;case R.REWARDED_INTERSTITIAL:s=this.rewardedInterstitialAdInstanceList;break}s&&s.push(t)}};l(co,"NormalAdInstance");let se=co;const{BaseAnalytics:kl,Events:ar}=p.Plugins.Analytics,Vl=[ar.BUTTON_CLICK,ar.SCREEN_OPEN],{Utils:{Array:Fl}}=p,lo=class lo extends kl{constructor(t,s){super(t,"FacebookAnalytics",{...s,color:"#0F52BA"});u(this,"prefix");this.prefix=s.prefix}processEvent(t,s){if(!("logEvent"in GameSDK.extra)||Fl.has(Vl,t))return;const a=this.addPrefixToEventName(t);GameSDK.extra.logEvent(a,1,s)}addPrefixToEventName(t){return`${this.prefix}_${t}`}};l(lo,"FacebookAnalytics");let ba=lo;const{BaseAnalytics:Ul,Events:Bl}=p.Plugins.Analytics,jl=[Bl.SCREEN_OPEN],{Utils:{Array:Kl}}=p,ho=class ho extends Ul{constructor(e,t){super(e,"FirebaseAnalytics",{...t,color:"#FFCA28"})}setUser(e,t){var s;(s=this.game.firebase.services.analytics)==null||s.setUser(e,t)}processEvent(e,t){var s;Kl.has(jl,e)||(s=this.game.firebase.services.analytics)==null||s.event(e,t)}};l(ho,"FirebaseAnalytics");let Na=ho;const{BaseAnalytics:Wl,Events:Lt}=p.Plugins.Analytics,zl=[Lt.SCREEN_OPEN],{Utils:{Array:Hl}}=p,uo=class uo extends Wl{constructor(e,t){super(e,"GoogleAnalytics",{...t,color:"#E35335"})}processEvent(e,t){Hl.has(zl,e)||(this.customEvent(e,t),gtag("event",e,t))}customEvent(e,t){switch(e){case Lt.AD_SHOW:case Lt.AD_SHOW_FAILED:case Lt.AD_SHOWING:case Lt.USE_ITEM:case Lt.EARN_ITEM:this.addLevelName(t);break}}addLevelName(e){if(!e||!(game!=null&&game.match))return;const s=game.match.getMatchState().customData.level;s<0||(e.level_name=this.getLevelName(s))}};l(uo,"GoogleAnalytics");let Ca=uo;const ql="production",La="103",{Dtos:Yl,Events:ae,Configs:S,Utils:Ql}=p,{Object:nr,Json:ne,String:ir,Valid:Xl,Mark:b}=Ql,yo=class yo extends T.Game{constructor(){super(...arguments);u(this,"markName","Core Initialize");u(this,"modulePlugins",[]);u(this,"handleProtectGameInstance",l(()=>{const t=this.event.getEventEmitCount(ot.MODULE_PLUGIN_READY),s=this.modulePlugins.length;t<s||(window.game=Object.freeze(window.game))},"handleProtectGameInstance"));u(this,"initMonitorErrorPlugin",l(()=>{if(!this.monitorError)return;const{MonitorError:t,ListPlayerDevIds:s}=S.Debugger,{ApiKey:a,Service:n,Feedback:i,TrackUser:o,FilterErrors:r}=t,c=GameSDK.player.getID(),d=GameSDK.player.getName();c&&s.indexOf(c)>=0||(this.monitorError.configure({apiKey:a,service:n,feedback:i,trackUser:o,releaseStage:ql,buildVersion:`${La}`}),this.monitorError.setUser({id:c,name:d}),this.monitorError.addFilterErrors(r),this.monitorError.initFeedbackTrackErrors(),this.updateMonitorErrorUserAndMetadata(),this.processErrorsQueue())},"initMonitorErrorPlugin"));u(this,"updateMonitorErrorUserAndMetadata",l(()=>{this.event.catchUp(ae.PLAYER_INFO_LOADED,this.processWhenPlayerInfoLoaded)},"updateMonitorErrorUserAndMetadata"));u(this,"processErrorsQueue",l(()=>{if(this.monitorError&&window.__errorQueue){for(const t of window.__errorQueue)if(t instanceof Error)this.monitorError.sendException(t);else{const{message:s,code:a,stack:n}=t||{message:"",code:"Unknown",stack:"Unknown stack"},i=new Error(s||a);i.stack=n,this.monitorError.sendException(i)}window.__errorQueue=null}},"processErrorsQueue"));u(this,"processWhenPlayerInfoLoaded",l(()=>{if(!this.monitorError)return;const{playerId:t,name:s}=this.player.getPlayer();this.monitorError.setUser({id:t,name:s}),this.monitorError.addMetadata({isFirstLogin:this.player.isFirstLogin()})},"processWhenPlayerInfoLoaded"));u(this,"handleSaveRemoteConfig",l(t=>{try{const s={[t.type]:t};this.player.setPlayerDataByName("remoteConfig",s)}catch(s){console.warn("handleSaveGameCoreConfig",s)}},"handleSaveRemoteConfig"));u(this,"handleUpdateGameCoreConfig",l(t=>{try{const{id:s,type:a}=t;if(a!=="GameCore")return;p.Configs=nr.merge(p.Configs,t.config);const{Ads:n}=p.Configs;this.ads.configure(n),this.event.emit(ot.REMOTE_CONFIG_UPDATED,{id:s,type:a})}catch(s){console.warn("handleUpdateGameCoreConfig",s)}},"handleUpdateGameCoreConfig"));u(this,"handleStorageCurrentRemoteConfig",l(()=>{const t=this.player.getPlayerDataByKey("remoteConfig");if(console.info("playerRemoteConfig",ne.clone(t)),!!t){for(const s in t)if(nr.hasOwn(t,s)){const a=t[s],n=ne.clone(a);console.log("newRemoteConfig",n);const i=new Yl.RemoteConfig.Data(n).toObject();console.info("remoteConfigValid",i),this.remoteConfig.setRemoteConfig(i),this.remoteConfig.processUpdateConfig(i.id,i.type)}}},"handleStorageCurrentRemoteConfig"));u(this,"initAdaptivePerformancePlugin",l(()=>{if(!this.adaptivePerformance)return;const t=ne.clone(S.AdaptivePerformance);this.adaptivePerformance.configure(t)},"initAdaptivePerformancePlugin"));u(this,"processAfterSyncProfile",l(()=>{const{Notification:t}=S;t.Enabled&&this.updatePlayerProfileToNotificationService()},"processAfterSyncProfile"))}getBuildVersion(){return Number.parseInt(`${La}`)||0}async boot(){console.groupEnd(),console.groupCollapsed(" GameCore Boot"),super.boot(),this.addPlugins(),this.initEventPlugin(),this.event.emit(ae.CORE_BOOTING),this.initFirebasePlugin(),this.initMarkCoreInitialize(),b.putAttr(this.markName,"Step","Init Plugins"),this.initAds(),this.initMatchPlugin(),this.initRemoteConfig(),b.putAttr(this.markName,"Step","Load Lazy Plugins"),Xl.isDebugger()||this.event.on(ae.MODULE_PLUGIN_READY,this.handleProtectGameInstance),this.addMonitorPlugin().then(this.initMonitorErrorPlugin),this.addAdaptivePerformancePlugin().then(this.initAdaptivePerformancePlugin),b.putAttr(this.markName,"Step","Load Dev Plugins"),this.addDevPlugins()}async start(){console.groupEnd(),console.groupCollapsed(" GameCore Start"),super.start(),b.putAttr(this.markName,"Step","Core Start"),this.event.emit(ae.CORE_STARTING),b.putAttr(this.markName,"Step","Request Token"),await this.auth.requestToken(),b.putAttr(this.markName,"Step","Init States"),await this.initState(),b.putAttr(this.markName,"Step","Process Player Profile"),this.processPlayerProfile(),b.putAttr(this.markName,"Step","Process Context Payload"),await this.context.detectContextSessionType(),this.context.detectContextGameMode();const t=this.storage.getStorageData("context","sessionContextType")||"unknown";b.putAttr(this.markName,"Context Mode",t),b.putAttr(this.markName,"Step","Init Analytics"),this.initGoogleAnalytics(),this.initFirebaseAnalytics(),this.initFacebookAnalytics(),b.putAttr(this.markName,"Step","Core Ready"),b.putAttr(this.markName,"Success","true"),b.stop(this.markName),this.event.emit(ae.CORE_READY)}addPlugins(){this.installPlugin("Storage",Ea),this.installPlugin("Event",es),this.installPlugin("Ads",Ue),this.installPlugin("Auth",ze),this.installPlugin("Audio",We),this.installPlugin("Match",Aa),this.installPlugin("Player",Ia),this.installPlugin("Profile",Pa),this.installPlugin("Context",Ye),this.installPlugin("Language",us),this.installPlugin("Analytics",Be),this.installPlugin("Visibility",xa),this.installPlugin("Leaderboard",ps),this.installPlugin("DailyRewards",Ze),this.installPlugin("FrameCapture",ds),this.installPlugin("RemoteConfig",ss),"Proxy"in window&&this.installPlugin("Firebase",ss)}installPlugin(t,s,a=!1){const n=ir.toCamelCase(ir.capitalize(t));this.plugins.install(t,s,!0,n),t!=="Storage"&&(a?this.emitModulePluginReady(t):this.emitCorePluginReady(t))}async addMonitorPlugin(){var a;(a=window.disableSimpleTrackErrors)==null||a.call(window);const{MonitorError:t}=S.Debugger;if(!t.Enabled)return;this.modulePlugins.push("MonitorError");const s=(await it(async()=>{const{default:n}=await Promise.resolve().then(()=>Ut);return{default:n}},void 0,N.meta.url)).default;typeof s=="function"&&this.installPlugin("MonitorError",s,!0)}async addAdaptivePerformancePlugin(){const{AdaptivePerformance:t}=S;if(!t.Enabled)return;this.modulePlugins.push("AdaptivePerformance");const s=(await it(async()=>{const{default:a}=await N.import("./bundle/index.js");return{default:a}},void 0,N.meta.url)).default;typeof s=="function"&&this.installPlugin("AdaptivePerformance",s,!0)}addDevPlugins(){var a;const{ListPlayerDevIds:t}=S.Debugger,s=(a=GameSDK==null?void 0:GameSDK.player)==null?void 0:a.getID();!s||t.indexOf(s)<0||(this.addConsolePlugin(),this.addProfilerPlugin(),this.addCanvasRecorderPlugin())}async addConsolePlugin(){try{const{Console:t}=S.Debugger;if(!t.Enabled)return;this.modulePlugins.push("Console");const s=(await it(async()=>{const{default:a}=await N.import("./bundle/console.js");return{default:a}},void 0,N.meta.url)).default;if(typeof s!="function")throw new Error("ConsolePlugin is not a function");this.installPlugin("Console",s,!0),this.initConsolePlugin()}catch(t){console.error("Error importing Console plugin:",t)}}async addProfilerPlugin(){try{const{Profiler:t}=S.Debugger;if(!t.Enabled)return;this.modulePlugins.push("Profiler");const s=(await it(async()=>{const{default:a}=await Promise.resolve().then(()=>Ut);return{default:a}},void 0,N.meta.url)).default;if(typeof s!="function")throw new Error("ProfilerPlugin is not a function");this.installPlugin("Profiler",s,!0),this.initProfilerPlugin()}catch(t){console.error("Error importing Profiler plugin:",t)}}async addCanvasRecorderPlugin(){try{const{CanvasRecorder:t}=S.Debugger;if(!t.Enabled)return;this.modulePlugins.push("CanvasRecorder");const s=(await it(async()=>{const{default:a}=await Promise.resolve().then(()=>Ut);return{default:a}},void 0,N.meta.url)).default;if(typeof s!="function")throw new Error("CanvasRecorderPlugin is not a function");this.installPlugin("CanvasRecorder",s,!0),this.initCanvasRecorderPlugin()}catch(t){console.error("Error importing Canvas Recorder plugin:",t)}}emitCorePluginReady(t){this.event.emit(ot.CORE_PLUGIN_READY,{name:t})}emitModulePluginReady(t){this.event.emit(ot.MODULE_PLUGIN_READY,{name:t})}initEventPlugin(){const{EventLogging:t}=S.Debugger;t.Enabled&&this.event.enableLogEvent()}initMatchPlugin(){this.match.setUseCPUProfile(!1)}initAds(){const{Ads:t}=p.Plugins;this.ads.configure(S.Ads),this.initAdInstance(t,S)}initAdInstance(t,s){const{InterstitialAdOptions:a,RewardedVideoAdOptions:n,RewardedInterstitialAdOptions:i,BannerDisplayAdOptions:o}=s.Ads;for(const r of a)this.ads.setAdInstance(t.Types.INTERSTITIAL,r.PlacementId,se);for(const r of n)this.ads.setAdInstance(t.Types.REWARDED_VIDEO,r.PlacementId,se);for(const r of i)this.ads.setAdInstance(t.Types.REWARDED_INTERSTITIAL,r.PlacementId,se);for(const r of o)this.ads.setAdInstance(t.Types.BANNER,r.PlacementId,Sa)}async initState(){try{const t=new $e(this);t.initContext(),await t.initPlayer()}catch(t){console.error("StateInitiator",t)}}initConsolePlugin(){this.console&&this.console.configure()}initProfilerPlugin(){this.profiler&&this.profiler.configure()}initCanvasRecorderPlugin(){if(!this.canvasRecorder)return;const{CanvasRecorder:t}=S.Debugger,{Type:s,Quality:a,RecordFps:n,SyncFps:i}=t.Options;this.canvasRecorder.configure({type:s,quality:a,syncFps:i,recordFps:n});const o=document.querySelector("canvas");if(!o){console.error("Canvas not found");return}this.canvasRecorder.setCanvas(o)}initRemoteConfig(){const{RemoteConfig:t}=S;if(!t.Enabled)return;const s=ne.clone(t);this.remoteConfig.configure(s),this.event.on(ot.REQUEST_SAVE_CONFIG,this.handleSaveRemoteConfig),this.event.on(ot.REQUEST_UPDATE_CONFIG,this.handleUpdateGameCoreConfig),this.event.catchUp(ot.PLAYER_INFO_LOADED,this.handleStorageCurrentRemoteConfig)}initFirebasePlugin(){const{Firebase:t}=S;if(!t.Enabled||!this.firebase)return;const s=ne.clone(t);this.firebase.configure(s),b.setService(this.firebase.services.performance)}initMarkCoreInitialize(){S.PerformanceMonitor.CoreFlows&&(b.measure(this.markName),b.putAttr(this.markName,"Build",`${La}`),b.putAttr(this.markName,"GameSDK",GameSDK.getSDKName()),b.putAttr(this.markName,"Platform",GameSDK.getPlatform()),b.putAttr(this.markName,"Success","false"),b.start(this.markName))}async processPlayerProfile(){try{await this.player.syncProfileToServer(),this.processAfterSyncProfile()}catch(t){console.warn("processPlayerProfile fail",t)}}async updatePlayerProfileToNotificationService(){try{const{AppId:t}=S,s=this.player.getPlayer(),{ASID:a,playerId:n,name:i,photo:o,locale:r}=s;await Pr({appId:t,ASID:a,playerId:n,name:i,photo:o,locale:r})}catch(t){console.warn("updatePlayerProfileToNotificationService",t)}}initGoogleAnalytics(){const{Enabled:t,ConsoleLog:s}=S.Analytics.GoogleAnalytics??{};t&&this.analytics.add(new Ca(this.game,{log:!!s}))}initFirebaseAnalytics(){const{Enabled:t,ConsoleLog:s}=S.Analytics.FirebaseAnalytics??{};if(!t)return;const a=new Na(this.game,{log:!!s});this.analytics.add(a);let n="no_entry";GameSDK.getEntryPointAsync().then(i=>{n=i}).catch(i=>{console.warn(i)}).finally(()=>{const i=this.player.getPlayer(),{playerId:o,locale:r}=i,{fbig_ad_id:c,fbig_adset_id:d,fbig_campaign_id:h}=GameSDK.getEntryPointData()||{};a.setUser(o,{locale:r,ad_id:c,adset_id:d,campaign_id:h,traffic_source:n})})}initFacebookAnalytics(){const{Enabled:t,Prefix:s,ConsoleLog:a}=S.Analytics.FacebookAnalytics??{};if(t){if(typeof s!="string"){console.warn("Facebook Analytics is not configured");return}this.analytics.add(new ba(this.game,{prefix:s,log:!!a}))}}};l(yo,"MagicGame");let Ta=yo;const{Configs:{GameEngine:{ForceDesktopDPR:Oe}},Utils:{Device:Jl},Events:Oa}=p,Zl=l(async()=>{const f=new Ta;window.game=f;const e=20;window.__sdkLoadingCount<e&&(window.__sdkLoadingCount=e),window.__gameCoreStart=!0,await f.boot(),f.event.catchUp(Oa.REQUEST_CORE_START,or),td(f)},"initGame"),or=l(()=>{if(!window.__sdkInitiated){game.event.catchUp(Oa.GAME_SDK_READY,or);return}window.game.start(),console.warn("Game started");const f=25;window.__sdkLoadingCount<f&&(window.__sdkLoadingCount=f)},"startGame"),td=l(f=>{const t=setInterval(()=>{if(!window.__sdkInitiated)return;clearInterval(t);const s=10;window.__sdkLoadingCount<s&&(window.__sdkLoadingCount=s),f.event.emit(Oa.GAME_SDK_READY)},5)},"waitGameSDK");Oe!==!1&&Jl.isDesktop()&&typeof Oe=="number"&&Oe>0&&(window.devicePixelRatio=Oe),Zl()},"execute")}});
